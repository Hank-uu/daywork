<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>日常紀錄小幫手</title>

  <!-- 1. 載入 Tailwind CSS (處理畫面樣式) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- 2. 載入 React 與 ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

  <!-- 3. 載入 Babel (讓瀏覽器能即時解析 React 的 JSX 語法) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- 4. 設定 Firebase ES Modules 的 Import Map -->
  <script type="importmap">
    {
      "imports": {
        "firebase/app": "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"
      }
    }
  </script>
</head>
<body class="bg-gray-100">
  
  <div id="root"></div>

  <!-- 5. 主程式碼 -->
  <script type="text/babel" data-type="module">
    // --- 引入 Firebase ---
    import { initializeApp } from 'firebase/app';
    import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from 'firebase/auth';
    import { getFirestore, collection, doc, setDoc, deleteDoc, updateDoc, onSnapshot } from 'firebase/firestore';

    // 加入 createContext 與 useContext
    const { useState, useEffect, useMemo, createContext, useContext } = React;

    // --- 自訂 SVG 圖示 ---
    const iconsMap = {
      Plus: (
        <React.Fragment>
          <line x1="12" x2="12" y1="5" y2="19" />
          <line x1="5" x2="19" y1="12" y2="12" />
        </React.Fragment>
      ),
      ChevronLeft: <polyline points="15 18 9 12 15 6" />,
      ChevronRight: <polyline points="9 18 15 12 9 6" />,
      Trash2: (
        <React.Fragment>
          <path d="M3 6h18" />
          <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" />
          <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" />
          <line x1="10" x2="10" y1="11" y2="17" />
          <line x1="14" x2="14" y1="11" y2="17" />
        </React.Fragment>
      ),
      CalendarIcon: (
        <React.Fragment>
          <rect width="18" height="18" x="3" y="4" rx="2" ry="2" />
          <line x1="16" x2="16" y1="2" y2="6" />
          <line x1="8" x2="8" y1="2" y2="6" />
          <line x1="3" x2="21" y1="10" y2="10" />
        </React.Fragment>
      ),
      Clock: (
        <React.Fragment>
          <circle cx="12" cy="12" r="10" />
          <polyline points="12 6 12 12 16 14" />
        </React.Fragment>
      ),
      X: (
        <React.Fragment>
          <line x1="18" x2="6" y1="6" y2="18" />
          <line x1="6" x2="18" y1="6" y2="18" />
        </React.Fragment>
      ),
      Check: <polyline points="20 6 9 17 4 12" />,
      LogOut: (
        <React.Fragment>
          <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
          <polyline points="16 17 21 12 16 7" />
          <line x1="21" x2="9" y1="12" y2="12" />
        </React.Fragment>
      ),
      User: (
        <React.Fragment>
          <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2" />
          <circle cx="12" cy="7" r="4" />
        </React.Fragment>
      ),
      Cloud: <path d="M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9Z" />,
      Smartphone: (
        <React.Fragment>
          <rect width="14" height="20" x="5" y="2" rx="2" ry="2" />
          <path d="M12 18h.01" />
        </React.Fragment>
      ),
      Settings: (
        <React.Fragment>
          <circle cx="12" cy="12" r="3" />
          <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z" />
        </React.Fragment>
      ),
      Edit2: (
        <React.Fragment>
          <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z" />
        </React.Fragment>
      ),
      Palette: (
        <React.Fragment>
          <circle cx="13.5" cy="6.5" r=".5" />
          <circle cx="17.5" cy="10.5" r=".5" />
          <circle cx="8.5" cy="7.5" r=".5" />
          <circle cx="6.5" cy="12.5" r=".5" />
          <path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.012 17.461 2 12 2z" />
        </React.Fragment>
      )
    };

    const Icon = ({ name, size = 24, className = '', ...props }) => (
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width={size}
        height={size}
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        strokeWidth="2"
        strokeLinecap="round"
        strokeLinejoin="round"
        className={className}
        {...props}
      >
        {iconsMap[name]}
      </svg>
    );

    const Plus = (p) => <Icon name="Plus" {...p} />;
    const ChevronLeft = (p) => <Icon name="ChevronLeft" {...p} />;
    const ChevronRight = (p) => <Icon name="ChevronRight" {...p} />;
    const Trash2 = (p) => <Icon name="Trash2" {...p} />;
    const CalendarIcon = (p) => <Icon name="CalendarIcon" {...p} />;
    const Clock = (p) => <Icon name="Clock" {...p} />;
    const X = (p) => <Icon name="X" {...p} />;
    const Check = (p) => <Icon name="Check" {...p} />;
    const LogOut = (p) => <Icon name="LogOut" {...p} />;
    const User = (p) => <Icon name="User" {...p} />;
    const Cloud = (p) => <Icon name="Cloud" {...p} />;
    const Smartphone = (p) => <Icon name="Smartphone" {...p} />;
    const Settings = (p) => <Icon name="Settings" {...p} />;
    const Edit2 = (p) => <Icon name="Edit2" {...p} />;
    const Palette = (p) => <Icon name="Palette" {...p} />;

    // --- Firebase 設定 (您的專屬設定) ---
    const firebaseConfig = {
      apiKey: "AIzaSyCnQEe7z0gvsdm3lTDZWus6scdSSD6ooEU",
      authDomain: "mywork-26db5.firebaseapp.com",
      projectId: "mywork-26db5",
      storageBucket: "mywork-26db5.firebasestorage.app",
      messagingSenderId: "168509668059",
      appId: "1:168509668059:web:e80165656aabd430e02afe",
      measurementId: "G-TFX7B1E9JK"
    };
    
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- 工具函式 ---
    const generateId = () => Math.random().toString(36).substr(2, 9);

    const INITIAL_ACTIVITIES = [
      { id: generateId(), name: '吃藥', records: [] },
      { id: generateId(), name: '清洗冷氣濾網', records: [] },
      { id: generateId(), name: '運動', records: [] },
    ];

    // --- 主題設定 (Themes) ---
    const THEMES = {
      blue: {
        label: '經典藍', code: '#2563eb',
        bg: 'bg-blue-600', bgHover: 'hover:bg-blue-700', bgActive: 'active:bg-blue-700', bgDisabled: 'disabled:bg-blue-300',
        ring: 'focus:ring-blue-500', text: 'text-blue-600', textIcon: 'text-blue-500',
        bgLight: 'bg-blue-100', bgLightHover: 'hover:bg-blue-200', textLight: 'text-blue-700', textDark: 'text-blue-800',
        border: 'border-blue-600', calendarDot: 'bg-blue-500', hoverBgLight: 'hover:bg-blue-50'
      },
      pink: {
        label: '櫻花粉', code: '#ec4899',
        bg: 'bg-pink-600', bgHover: 'hover:bg-pink-700', bgActive: 'active:bg-pink-700', bgDisabled: 'disabled:bg-pink-300',
        ring: 'focus:ring-pink-500', text: 'text-pink-600', textIcon: 'text-pink-500',
        bgLight: 'bg-pink-100', bgLightHover: 'hover:bg-pink-200', textLight: 'text-pink-700', textDark: 'text-pink-800',
        border: 'border-pink-600', calendarDot: 'bg-pink-500', hoverBgLight: 'hover:bg-pink-50'
      },
      purple: {
        label: '夢幻紫', code: '#9333ea',
        bg: 'bg-purple-600', bgHover: 'hover:bg-purple-700', bgActive: 'active:bg-purple-700', bgDisabled: 'disabled:bg-purple-300',
        ring: 'focus:ring-purple-500', text: 'text-purple-600', textIcon: 'text-purple-500',
        bgLight: 'bg-purple-100', bgLightHover: 'hover:bg-purple-200', textLight: 'text-purple-700', textDark: 'text-purple-800',
        border: 'border-purple-600', calendarDot: 'bg-purple-500', hoverBgLight: 'hover:bg-purple-50'
      },
      green: {
        label: '自然綠', code: '#16a34a',
        bg: 'bg-green-600', bgHover: 'hover:bg-green-700', bgActive: 'active:bg-green-700', bgDisabled: 'disabled:bg-green-300',
        ring: 'focus:ring-green-500', text: 'text-green-600', textIcon: 'text-green-500',
        bgLight: 'bg-green-100', bgLightHover: 'hover:bg-green-200', textLight: 'text-green-700', textDark: 'text-green-800',
        border: 'border-green-600', calendarDot: 'bg-green-500', hoverBgLight: 'hover:bg-green-50'
      }
    };

    const AppThemeContext = createContext();

    // ==========================================
    // Main App Component
    // ==========================================
    function App() {
      const [authUser, setAuthUser] = useState(null);
      const [showSettings, setShowSettings] = useState(false);
      
      const [storageMode, setStorageMode] = useState(() => localStorage.getItem('tracker_storage_mode') || null);
      
      const [themeColor, setThemeColor] = useState(() => localStorage.getItem('tracker_theme_color') || 'blue');
      const [headerText, setHeaderText] = useState(() => localStorage.getItem('tracker_header_text') || 'text-white');
      
      const [activities, setActivities] = useState([]);
      const [isLoading, setIsLoading] = useState(true);
      const [newActivityName, setNewActivityName] = useState('');
      const [selectedActivityId, setSelectedActivityId] = useState(null);

      const displayName = authUser ? (authUser.displayName || authUser.email) : '本機使用者';

      useEffect(() => {
        const unsubscribe = onAuthStateChanged(auth, (user) => {
          setAuthUser(user);
          // 如果使用者登出，但目前是雲端模式，則重置狀態
          if (!user && storageMode === 'cloud') {
            setStorageMode(null);
            localStorage.removeItem('tracker_storage_mode');
          }
        });
        return () => unsubscribe();
      }, [storageMode]);

      useEffect(() => {
        if (storageMode === 'cloud') {
          if (!authUser) {
            setIsLoading(false);
            return;
          }
          setIsLoading(true);
          // 雲端路徑：依據 Google 帳號的 UID 分開儲存
          const colRef = collection(db, 'users', authUser.uid, 'activities');
          
          const unsubscribe = onSnapshot(colRef, (snapshot) => {
            const data = snapshot.docs.map(doc => doc.data());
            data.sort((a, b) => a.id.localeCompare(b.id)); 
            setActivities(data);
            setIsLoading(false);
          }, (error) => {
            console.error("Firestore error:", error);
            setIsLoading(false);
            // 偵測權限錯誤
            if (error.code === 'permission-denied') {
              alert("❌ 資料庫權限不足！\n\n請至 Firebase 控制台 -> Firestore Database -> Rules (規則)。\n將規則修改為：\nallow read, write: if request.auth != null;");
            }
          });

          return () => unsubscribe();
        } 
        
        if (storageMode === 'local') {
          const saved = localStorage.getItem('activityTrackerData_local') || localStorage.getItem('activityTrackerData');
          if (saved) {
            try { setActivities(JSON.parse(saved)); } catch (e) { setActivities([]); }
          } else {
            setActivities([]);
          }
          setIsLoading(false);
        }
      }, [authUser, storageMode]);

      useEffect(() => {
        if (storageMode === 'local') {
          localStorage.setItem('activityTrackerData_local', JSON.stringify(activities));
        }
      }, [activities, storageMode]);

      useEffect(() => {
        localStorage.setItem('tracker_theme_color', themeColor);
        localStorage.setItem('tracker_header_text', headerText);
      }, [themeColor, headerText]);

      const themeValue = useMemo(() => ({
        themeColor, t: THEMES[themeColor] || THEMES.blue, headerText, setThemeColor, setHeaderText
      }), [themeColor, headerText]);

      const handleLoginGoogle = async () => {
        const provider = new GoogleAuthProvider();
        try {
          await signInWithPopup(auth, provider);
          setStorageMode('cloud');
          localStorage.setItem('tracker_storage_mode', 'cloud');
        } catch (error) {
          console.error("Login Error:", error);
          if (error.code === 'auth/unauthorized-domain') {
            alert(`❌ 網域未授權！\n\nFirebase 封鎖了來自目前網址的登入請求。\n\n解決方法：\n請至 Firebase 控制台 -> Authentication -> Settings (設定) -> Authorized domains (授權的網域)。\n點擊「新增網域」，然後輸入：\n${window.location.hostname}\n並儲存即可！`);
          } else if (error.code === 'auth/operation-not-allowed') {
             alert("❌ 尚未啟用 Google 登入！\n\n請至 Firebase 控制台 -> Authentication -> Sign-in method。\n新增提供者並「啟用 Google 登入」。");
          } else if (error.code === 'auth/configuration-not-found') {
             alert("❌ 找不到 Google 登入設定！\n\n請前往 Firebase 控制台的「Authentication」->「Sign-in method」，確定您已經新增了「Google」提供者並點擊了儲存。");
          } else {
            alert("登入失敗：" + error.message);
          }
        }
      };

      const handleLoginLocal = () => {
        setStorageMode('local');
        localStorage.setItem('tracker_storage_mode', 'local');
      };

      const handleLogout = async () => {
        if (storageMode === 'cloud') {
          await signOut(auth);
        }
        setStorageMode(null);
        localStorage.removeItem('tracker_storage_mode');
        setActivities([]);
        setSelectedActivityId(null);
      };

      // 錯誤捕捉輔助函式
      const handleCloudWriteError = (err) => {
        console.error(err);
        if (err.code === 'permission-denied') {
          alert("❌ 寫入失敗：沒有權限！\n請檢查您的 Firestore Rules 是否允許登入者寫入資料。");
        } else {
          alert("❌ 雲端操作失敗：" + err.message);
        }
      };

      const loadDefaultActivities = async () => {
        setIsLoading(true);
        if (storageMode === 'cloud' && authUser) {
          try {
            for (const act of INITIAL_ACTIVITIES) {
              await setDoc(doc(db, 'users', authUser.uid, 'activities', act.id), act);
            }
          } catch (err) { handleCloudWriteError(err); }
        } else if (storageMode === 'local') {
          setActivities(INITIAL_ACTIVITIES);
        }
        setIsLoading(false);
      };

      const handleAddActivity = async (e) => {
        e.preventDefault();
        if (!newActivityName.trim()) return;
        const newId = generateId();
        const newActivity = { id: newId, name: newActivityName.trim(), records: [] };

        if (storageMode === 'cloud' && authUser) {
          try {
            await setDoc(doc(db, 'users', authUser.uid, 'activities', newId), newActivity);
          } catch (err) { handleCloudWriteError(err); }
        } else if (storageMode === 'local') {
          setActivities(prev => [...prev, newActivity]);
        }
        setNewActivityName('');
      };

      const handleRenameActivity = async (id, newName) => {
        if (!newName.trim()) return;
        const activity = activities.find(a => a.id === id);
        if (!activity) return;

        if (storageMode === 'cloud' && authUser) {
          try {
            await updateDoc(doc(db, 'users', authUser.uid, 'activities', id), { name: newName.trim() });
          } catch (err) { handleCloudWriteError(err); }
        } else if (storageMode === 'local') {
          setActivities(prev => prev.map(act => 
            act.id === id ? { ...act, name: newName.trim() } : act
          ));
        }
      };

      const handleAddRecord = async (id, e) => {
        if (e) e.stopPropagation();
        
        const activity = activities.find(a => a.id === id);
        if (!activity) return;
        const now = new Date().toISOString();

        if (storageMode === 'cloud' && authUser) {
          try {
            await updateDoc(doc(db, 'users', authUser.uid, 'activities', id), { records: [...activity.records, now] });
          } catch (err) { handleCloudWriteError(err); }
        } else if (storageMode === 'local') {
          setActivities(prev => prev.map(act => 
            act.id === id ? { ...act, records: [...act.records, now] } : act
          ));
        }
      };

      const handleDeleteActivity = async (id) => {
        if (storageMode === 'cloud' && authUser) {
          try {
            await deleteDoc(doc(db, 'users', authUser.uid, 'activities', id));
          } catch (err) { handleCloudWriteError(err); }
        } else if (storageMode === 'local') {
          setActivities(prev => prev.filter(act => act.id !== id));
        }
        setSelectedActivityId(null);
      };

      const handleDeleteRecord = async (id, recordStr) => {
        const activity = activities.find(a => a.id === id);
        if (!activity) return;

        const newRecords = activity.records.filter(r => r !== recordStr);
        
        if (storageMode === 'cloud' && authUser) {
          try {
            await updateDoc(doc(db, 'users', authUser.uid, 'activities', id), { records: newRecords });
          } catch (err) { handleCloudWriteError(err); }
        } else if (storageMode === 'local') {
          setActivities(prev => prev.map(act => 
            act.id === id ? { ...act, records: newRecords } : act
          ));
        }
      };

      const handleClearRecords = async (id, beforeDateStr) => {
        const activity = activities.find(a => a.id === id);
        if (!activity) return;

        const cutoffTime = new Date(beforeDateStr).getTime();
        const filteredRecords = activity.records.filter(r => new Date(r).getTime() >= cutoffTime);
        
        if (storageMode === 'cloud' && authUser) {
          try {
            await updateDoc(doc(db, 'users', authUser.uid, 'activities', id), { records: filteredRecords });
          } catch (err) { handleCloudWriteError(err); }
        } else if (storageMode === 'local') {
          setActivities(prev => prev.map(act => 
            act.id === id ? { ...act, records: filteredRecords } : act
          ));
        }
      };

      const selectedActivity = activities.find(a => a.id === selectedActivityId);

      if (!storageMode) {
        return (
          <AppThemeContext.Provider value={themeValue}>
            <div className="min-h-screen bg-gray-100 flex items-center justify-center font-sans p-4">
              <div className="bg-white p-8 rounded-2xl shadow-xl max-w-sm w-full">
                <div className="flex justify-center gap-4 mb-6">
                  <div className={`${themeValue.t.bgLight} p-4 rounded-full ${themeValue.t.text}`}>
                    <Cloud size={32} />
                  </div>
                  <div className="bg-gray-100 p-4 rounded-full text-gray-600">
                    <Smartphone size={32} />
                  </div>
                </div>
                <h1 className="text-2xl font-bold text-center text-gray-800 mb-2">紀錄小幫手</h1>
                <p className="text-center text-gray-500 mb-8 text-sm">請選擇您的使用方式</p>
                
                <button
                  onClick={handleLoginGoogle}
                  className={`w-full ${themeValue.t.bg} text-white rounded-xl px-4 py-4 font-bold shadow-md ${themeValue.t.bgHover} transition flex items-center justify-center gap-2`}
                >
                  <User size={20} />
                  以 Google 帳號登入 (雲端同步)
                </button>

                <div className="relative flex py-6 items-center">
                  <div className="flex-grow border-t border-gray-200"></div>
                  <span className="flex-shrink-0 mx-4 text-gray-400 text-sm">或</span>
                  <div className="flex-grow border-t border-gray-200"></div>
                </div>

                <button
                  onClick={handleLoginLocal}
                  className="w-full bg-gray-100 text-gray-700 rounded-xl px-4 py-3 font-bold shadow-sm hover:bg-gray-200 transition flex items-center justify-center gap-2"
                >
                  <Smartphone size={20} />
                  僅在本機使用 (免網路)
                </button>
              </div>
            </div>
          </AppThemeContext.Provider>
        );
      }

      if (isLoading && activities.length === 0) {
        return (
          <AppThemeContext.Provider value={themeValue}>
            <div className="min-h-screen bg-gray-100 flex items-center justify-center">
              <div className={`animate-spin rounded-full h-12 w-12 border-4 ${themeValue.t.border} border-t-transparent`}></div>
            </div>
          </AppThemeContext.Provider>
        );
      }

      return (
        <AppThemeContext.Provider value={themeValue}>
          <div className="min-h-screen bg-gray-100 font-sans text-gray-800">
            <div className="max-w-md mx-auto bg-white min-h-screen shadow-lg flex flex-col relative overflow-hidden">
              
              <header className={`${themeValue.t.bg} ${themeValue.headerText} p-4 shadow-md z-10 flex items-center justify-between transition-colors duration-300`}>
                <div className="flex items-center gap-2 flex-1 overflow-hidden">
                  {storageMode === 'cloud' ? <Cloud size={20} /> : <Smartphone size={20} />}
                  <h1 className="text-xl font-bold truncate">
                    {selectedActivity 
                      ? selectedActivity.name 
                      : (storageMode === 'cloud' ? `${displayName} 的紀錄` : '本機紀錄')}
                  </h1>
                </div>
                {!selectedActivityId && (
                  <div className="flex items-center ml-2">
                    <button onClick={() => setShowSettings(!showSettings)} className={`p-2 ${themeValue.t.bgHover} rounded-full transition`} title="設定與同步">
                      {showSettings ? <X size={20} /> : <Settings size={20} />}
                    </button>
                    <button onClick={handleLogout} className={`p-2 ${themeValue.t.bgHover} rounded-full transition ml-1`} title="切換模式或帳號">
                      <LogOut size={20} />
                    </button>
                  </div>
                )}
              </header>

              <main className="flex-1 overflow-y-auto">
                {showSettings ? (
                  <SettingsView 
                    onBack={() => setShowSettings(false)}
                    storageMode={storageMode}
                    authUser={authUser}
                    displayName={displayName}
                    activities={activities}
                    db={db}
                  />
                ) : !selectedActivityId ? (
                  <HomeView 
                    activities={activities}
                    newActivityName={newActivityName}
                    setNewActivityName={setNewActivityName}
                    onAddActivity={handleAddActivity}
                    onAddRecord={handleAddRecord}
                    onSelectActivity={setSelectedActivityId}
                    onLoadDefaults={loadDefaultActivities}
                  />
                ) : (
                  <DetailView 
                    activity={selectedActivity}
                    onBack={() => setSelectedActivityId(null)}
                    onAddRecord={() => handleAddRecord(selectedActivity.id)}
                    onRenameActivity={(newName) => handleRenameActivity(selectedActivity.id, newName)}
                    onDeleteRecord={(recordStr) => handleDeleteRecord(selectedActivity.id, recordStr)}
                    onClearRecords={(date) => handleClearRecords(selectedActivity.id, date)}
                    onDeleteActivity={() => handleDeleteActivity(selectedActivity.id)}
                  />
                )}
              </main>
            </div>
          </div>
        </AppThemeContext.Provider>
      );
    }

    // ==========================================
    // Home View Component
    // ==========================================
    function HomeView({ activities, newActivityName, setNewActivityName, onAddActivity, onAddRecord, onSelectActivity, onLoadDefaults }) {
      const { t } = useContext(AppThemeContext);
      const todayStr = new Date().toLocaleDateString('en-CA');

      return (
        <div className="p-4 flex flex-col h-full">
          <form onSubmit={onAddActivity} className="flex gap-2 mb-6">
            <input 
              type="text" 
              value={newActivityName}
              onChange={(e) => setNewActivityName(e.target.value)}
              placeholder="輸入新追蹤項目 (例: 喝水)" 
              className={`flex-1 border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 ${t.ring} text-lg shadow-sm`}
            />
            <button 
              type="submit" 
              disabled={!newActivityName.trim()}
              className={`${t.bg} text-white rounded-lg px-4 py-3 ${t.bgDisabled} ${t.bgActive} transition flex items-center shadow-sm`}
            >
              <Plus size={24} />
            </button>
          </form>

          <div className="flex-1 space-y-3">
            {activities.map(activity => {
              const todayCount = activity.records.filter(r => new Date(r).toLocaleDateString('en-CA') === todayStr).length;
              return (
              <div 
                key={activity.id} 
                onClick={() => onSelectActivity(activity.id)}
                className="bg-white border border-gray-100 rounded-xl p-4 shadow-sm hover:shadow-md transition cursor-pointer flex items-center justify-between group"
              >
                <div className="flex-1">
                  <h3 className="text-lg font-semibold text-gray-800">{activity.name}</h3>
                  <p className="text-sm text-gray-500 mt-1">
                    總計: <span className={`font-bold ${t.text}`}>{activity.records.length}</span> 次
                    <span className="mx-2 text-gray-300">|</span>
                    本日: <span className="font-bold text-green-600">{todayCount}</span> 次
                  </p>
                </div>
                <button 
                  onClick={(e) => onAddRecord(activity.id, e)}
                  className={`ml-4 ${t.bgLight} ${t.textLight} ${t.bgLightHover} rounded-full h-12 w-12 flex items-center justify-center font-bold text-lg transition-colors shadow-sm active:scale-95`}
                >
                  +1
                </button>
              </div>
            )})}

            {activities.length === 0 && (
              <div className="text-center py-10 flex flex-col items-center">
                <p className="text-gray-400 mb-4">目前沒有任何項目，請在上方新增！</p>
                {onLoadDefaults && (
                  <button 
                    onClick={onLoadDefaults}
                    className={`${t.bgLight} ${t.textLight} px-6 py-2 rounded-xl font-bold shadow-sm ${t.bgLightHover} transition`}
                  >
                    或點此載入預設項目
                  </button>
                )}
              </div>
            )}
          </div>
        </div>
      );
    }

    // ==========================================
    // Detail & Calendar View Component
    // ==========================================
    function DetailView({ activity, onBack, onAddRecord, onRenameActivity, onDeleteRecord, onClearRecords, onDeleteActivity }) {
      const { t } = useContext(AppThemeContext);
      const [currentMonth, setCurrentMonth] = useState(new Date());
      const [selectedDateStr, setSelectedDateStr] = useState(
        new Date().toLocaleDateString('en-CA') 
      );

      const todayStr = new Date().toLocaleDateString('en-CA');
      const todayCount = activity.records.filter(r => new Date(r).toLocaleDateString('en-CA') === todayStr).length;

      const year = currentMonth.getFullYear();
      const month = currentMonth.getMonth();
      const firstDayOfMonth = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();

      const recordsByDate = useMemo(() => {
        const map = {};
        activity.records.forEach(r => {
          const dateObj = new Date(r);
          const dateStr = dateObj.toLocaleDateString('en-CA');
          if (!map[dateStr]) map[dateStr] = [];
          map[dateStr].push({ dateObj, originalStr: r });
        });
        Object.keys(map).forEach(k => {
          map[k].sort((a, b) => b.dateObj - a.dateObj);
        });
        return map;
      }, [activity.records]);

      const handlePrevMonth = () => setCurrentMonth(new Date(year, month - 1, 1));
      const handleNextMonth = () => setCurrentMonth(new Date(year, month + 1, 1));

      const calendarDays = [];
      for (let i = 0; i < firstDayOfMonth; i++) calendarDays.push(null);
      for (let i = 1; i <= daysInMonth; i++) calendarDays.push(i);

      const selectedDayRecords = recordsByDate[selectedDateStr] || [];

      return (
        <div className="flex flex-col h-full bg-gray-50 pb-8">
          <div className="bg-white px-4 py-3 flex items-center justify-between shadow-sm sticky top-0 z-10">
            <button onClick={onBack} className="text-gray-600 hover:bg-gray-100 p-2 rounded-full transition">
              <ChevronLeft size={24} />
            </button>
            <div className="flex-1 text-center font-bold text-sm text-gray-800 flex flex-col">
              <span>總計 {activity.records.length} 次</span>
              <span className="text-green-600">本日 {todayCount} 次</span>
            </div>
            <button onClick={onAddRecord} className={`${t.text} ${t.hoverBgLight} p-2 rounded-full transition font-bold flex items-center gap-1`}>
              <Plus size={20} /> 記一筆
            </button>
          </div>

          <div className="p-4 space-y-6 flex-1 overflow-y-auto">
            <div className="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
              <div className="flex justify-between items-center p-4 bg-gray-50 border-b border-gray-100">
                <button onClick={handlePrevMonth} className="p-1 hover:bg-gray-200 rounded-full"><ChevronLeft size={20} /></button>
                <h2 className="font-bold text-lg">{year} 年 {month + 1} 月</h2>
                <button onClick={handleNextMonth} className="p-1 hover:bg-gray-200 rounded-full"><ChevronRight size={20} /></button>
              </div>

              <div className="grid grid-cols-7 text-center text-xs font-semibold text-gray-500 py-2 bg-white">
                <div>日</div><div>一</div><div>二</div><div>三</div><div>四</div><div>五</div><div>六</div>
              </div>

              <div className="grid grid-cols-7 text-center bg-white pb-2">
                {calendarDays.map((day, idx) => {
                  if (!day) return <div key={`empty-${idx}`} className="py-2"></div>;
                  
                  const dateStr = new Date(year, month, day).toLocaleDateString('en-CA');
                  const hasRecord = !!recordsByDate[dateStr];
                  const isSelected = selectedDateStr === dateStr;
                  const isToday = dateStr === new Date().toLocaleDateString('en-CA');

                  return (
                    <div key={day} className="py-1 px-1 flex justify-center">
                      <button 
                        onClick={() => setSelectedDateStr(dateStr)}
                        className={`w-10 h-10 rounded-full flex flex-col items-center justify-center relative transition-all
                          ${isSelected ? `${t.bg} text-white shadow-md` : 'hover:bg-gray-100'}
                          ${isToday && !isSelected ? `border ${t.border} ${t.text}` : ''}
                          ${!isSelected && !isToday ? 'text-gray-700' : ''}
                        `}
                      >
                        <span className="text-sm">{day}</span>
                        {hasRecord && (
                          <span className={`w-1.5 h-1.5 rounded-full mt-0.5 ${isSelected ? 'bg-white' : t.calendarDot}`}></span>
                        )}
                      </button>
                    </div>
                  );
                })}
              </div>
            </div>

            <div className="bg-white rounded-2xl shadow-sm border border-gray-100 p-4">
              <h3 className="font-bold flex items-center gap-2 text-gray-700 mb-4 border-b pb-2">
                <CalendarIcon size={18} />
                {selectedDateStr} 紀錄
                <span className="ml-auto text-sm font-normal text-gray-500">
                  共 {selectedDayRecords.length} 次
                </span>
              </h3>

              {selectedDayRecords.length > 0 ? (
                <ul className="space-y-3">
                  {selectedDayRecords.map((recordItem, idx) => (
                    <RecordItem 
                      key={idx} 
                      recordItem={recordItem} 
                      onDelete={onDeleteRecord} 
                    />
                  ))}
                </ul>
              ) : (
                <div className="text-center text-gray-400 py-6">這天沒有紀錄唷！</div>
              )}
            </div>

            <div className="pt-6 border-t border-gray-200">
              <h4 className="text-sm font-bold text-gray-400 uppercase tracking-wider mb-3 px-2">資料管理</h4>
              <div className="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden divide-y divide-gray-100">
                <div className="p-2 border-b border-gray-100">
                  <RenameAction currentName={activity.name} onSave={onRenameActivity} />
                </div>
                <ClearButton label="清除一週前的紀錄" days={7} onClear={onClearRecords} />
                <ClearButton label="清除一個月前的紀錄" days={30} onClear={onClearRecords} />
                <ClearButton label="清除一年前的紀錄" days={365} onClear={onClearRecords} />
                <div className="p-2">
                  <ConfirmButton initLabel="刪除此追蹤項目" confirmLabel="確定刪除？(無法復原)" onClick={onDeleteActivity} isDanger={true} />
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    }

    // ==========================================
    // Rename Action Component
    // ==========================================
    function RenameAction({ currentName, onSave }) {
      const { t } = useContext(AppThemeContext);
      const [isEditing, setIsEditing] = useState(false);
      const [name, setName] = useState(currentName);

      if (isEditing) {
        return (
          <div className="p-2 flex gap-2 w-full items-center">
            <input 
              type="text" 
              value={name} 
              onChange={e => setName(e.target.value)} 
              className={`flex-1 border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 ${t.ring}`}
              autoFocus
            />
            <button onClick={() => { setIsEditing(false); setName(currentName); }} className="p-2 text-gray-500 hover:bg-gray-200 rounded-lg transition"><X size={18} /></button>
            <button onClick={() => { onSave(name); setIsEditing(false); }} className={`p-2 ${t.bg} text-white ${t.bgHover} rounded-lg transition`}><Check size={18} /></button>
          </div>
        );
      }

      return (
        <button 
          onClick={() => setIsEditing(true)}
          className="w-full py-3 px-2 rounded-xl font-medium text-left transition flex items-center justify-between text-gray-700 hover:bg-gray-50"
        >
          <span className="px-2">重新命名此項目</span>
          <Edit2 size={18} className="text-gray-400 mr-2" />
        </button>
      );
    }

    // ==========================================
    // Record Item Component (For deleting specific time)
    // ==========================================
    function RecordItem({ recordItem, onDelete }) {
      const { t } = useContext(AppThemeContext);
      const [confirming, setConfirming] = useState(false);
      
      return (
        <li className="flex items-center justify-between bg-gray-50 p-3 rounded-lg text-gray-700">
          <div className="flex items-center gap-3">
            <Clock size={16} className={t.textIcon} />
            <span className="font-medium text-lg">
              {recordItem.dateObj.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit', second: '2-digit' })}
            </span>
          </div>
          {confirming ? (
            <div className="flex items-center gap-2">
              <button onClick={() => setConfirming(false)} className="text-gray-500 text-sm px-2 py-1 hover:bg-gray-200 rounded transition">取消</button>
              <button onClick={() => onDelete(recordItem.originalStr)} className="text-white text-sm bg-red-500 px-3 py-1 rounded shadow-sm hover:bg-red-600 transition">刪除</button>
            </div>
          ) : (
            <button 
              onClick={() => setConfirming(true)}
              className="text-gray-400 hover:text-red-500 hover:bg-red-50 p-2 rounded-full transition"
              title="刪除此筆紀錄"
            >
              <Trash2 size={18} />
            </button>
          )}
        </li>
      );
    }

    // ==========================================
    // Settings & Sync View Component
    // ==========================================
    function SettingsView({ onBack, storageMode, authUser, displayName, activities, db }) {
      const { t, themeColor, headerText, setThemeColor, setHeaderText } = useContext(AppThemeContext);
      const [statusMsg, setStatusMsg] = useState('');
      const [isProcessing, setIsProcessing] = useState(false);

      const TEXT_COLORS = [
        { label: '純淨白', text: 'text-white', code: '#ffffff' },
        { label: '深邃黑', text: 'text-gray-900', code: '#111827' },
        { label: '暖陽黃', text: 'text-yellow-300', code: '#fde047' }
      ];

      const showMessage = (msg) => {
        setStatusMsg(msg);
        setTimeout(() => setStatusMsg(''), 4000);
      };

      const handleLocalToCloud = async () => {
        setIsProcessing(true);
        if (!authUser) {
          showMessage('❌ 尚未登入。');
          setIsProcessing(false);
          return;
        }
        try {
          const localData = JSON.parse(localStorage.getItem('activityTrackerData_local') || '[]');

          // 清空目前雲端紀錄
          for (const act of activities) {
             await deleteDoc(doc(db, 'users', authUser.uid, 'activities', act.id));
          }
          // 寫入本機紀錄到雲端
          for (const act of localData) {
             await setDoc(doc(db, 'users', authUser.uid, 'activities', act.id), act);
          }
          showMessage('✅ 已成功將「本機紀錄」上傳並覆蓋「雲端」！');
        } catch (e) {
          console.error(e);
          if (e.code === 'permission-denied') {
             showMessage('❌ 同步失敗：權限不足。請檢查 Firebase Rules。');
          } else {
             showMessage('❌ 同步失敗，請稍後再試。');
          }
        }
        setIsProcessing(false);
      };

      const handleCloudToLocal = async () => {
        setIsProcessing(true);
        try {
          localStorage.setItem('activityTrackerData_local', JSON.stringify(activities));
          showMessage('✅ 已成功將「雲端紀錄」下載並覆蓋「本機」！');
        } catch (e) {
          showMessage('❌ 同步失敗，請稍後再試。');
        }
        setIsProcessing(false);
      };

      const handleDeleteCloud = async () => {
        setIsProcessing(true);
        if (!authUser) {
          showMessage('❌ 尚未登入。');
          setIsProcessing(false);
          return;
        }
        try {
          for (const act of activities) {
             await deleteDoc(doc(db, 'users', authUser.uid, 'activities', act.id));
          }
          showMessage('✅ 已成功刪除所有雲端紀錄！');
        } catch (e) {
          console.error(e);
          if (e.code === 'permission-denied') {
             showMessage('❌ 刪除失敗：權限不足。');
          } else {
             showMessage('❌ 刪除失敗，請稍後再試。');
          }
        }
        setIsProcessing(false);
      };

      return (
        <div className="flex flex-col h-full bg-gray-50 pb-8">
          <div className="bg-white px-4 py-3 flex items-center shadow-sm sticky top-0 z-10">
            <button onClick={onBack} className="text-gray-600 hover:bg-gray-100 p-2 rounded-full transition mr-2">
              <ChevronLeft size={24} />
            </button>
            <h2 className="font-bold text-lg text-gray-800">資料同步與設定</h2>
          </div>

          <div className="p-4 space-y-6 flex-1 overflow-y-auto">
            {statusMsg && (
              <div className={`${t.bgLight} ${t.textDark} p-3 rounded-xl text-center font-medium animate-pulse`}>
                {statusMsg}
              </div>
            )}

            <div className="bg-white rounded-2xl shadow-sm border border-gray-100 p-4">
              <h3 className="font-bold text-gray-700 mb-4 flex items-center gap-2">
                <Palette size={20} className={t.textIcon}/> 外觀設定
              </h3>
              
              <div className="mb-5">
                <p className="text-sm text-gray-600 mb-3">主題色彩：</p>
                <div className="flex gap-4">
                  {Object.entries(THEMES).map(([key, c]) => (
                    <button 
                      key={key}
                      onClick={() => setThemeColor(key)}
                      className={`w-10 h-10 rounded-full shadow-md border-2 transition-transform hover:scale-110 ${themeColor === key ? 'border-gray-800 scale-110' : 'border-transparent'}`}
                      style={{ backgroundColor: c.code }}
                      title={c.label}
                    />
                  ))}
                </div>
              </div>

              <div>
                <p className="text-sm text-gray-600 mb-3">標題文字顏色：</p>
                <div className="flex gap-4">
                  {TEXT_COLORS.map(c => (
                    <button 
                      key={c.text}
                      onClick={() => setHeaderText(c.text)}
                      className={`w-10 h-10 rounded-full shadow-md border-2 transition-transform hover:scale-110 flex items-center justify-center ${headerText === c.text ? 'border-gray-800 scale-110' : 'border-gray-200'}`}
                      style={{ backgroundColor: c.code }}
                      title={c.label}
                    >
                      <span className="text-xs font-bold" style={{ color: c.code === '#ffffff' ? '#000' : c.code }}>A</span>
                    </button>
                  ))}
                </div>
              </div>
            </div>

            {storageMode === 'cloud' ? (
              <div className="space-y-6">
                <div className="bg-white rounded-2xl shadow-sm border border-gray-100 p-4">
                   <h3 className="font-bold text-gray-700 mb-2 flex items-center gap-2">
                     <Cloud size={20} className={t.textIcon}/> 雲端同步管理
                   </h3>
                   <p className="text-sm text-gray-500 mb-4">目前管理帳戶：<br/><span className={`font-bold ${t.text}`}>{displayName}</span></p>

                   <div className="space-y-3 divide-y divide-gray-100">
                     <div className="py-3">
                       <p className="text-sm text-gray-600 mb-2">將暫存的本機資料，上傳並覆蓋此帳戶的雲端紀錄。</p>
                       <ConfirmButton 
                          initLabel="上傳：以「本機」覆蓋「雲端」" 
                          confirmLabel="確定上傳並覆蓋？" 
                          onClick={handleLocalToCloud}
                          disabled={isProcessing}
                       />
                     </div>
                     <div className="py-3">
                       <p className="text-sm text-gray-600 mb-2">將此帳戶的雲端紀錄，下載並覆蓋到這台裝置的本機紀錄。</p>
                       <ConfirmButton 
                          initLabel="下載：以「雲端」覆蓋「本機」" 
                          confirmLabel="確定下載並覆蓋？" 
                          onClick={handleCloudToLocal}
                          disabled={isProcessing}
                       />
                     </div>
                     <div className="py-3">
                       <p className="text-sm text-red-500 mb-2">永久清空此雲端帳戶的所有紀錄 (不影響本機)。</p>
                       <ConfirmButton 
                          initLabel="刪除所有雲端紀錄" 
                          confirmLabel="確定永久刪除？" 
                          onClick={handleDeleteCloud} 
                          isDanger={true}
                          disabled={isProcessing}
                       />
                     </div>
                   </div>
                </div>
              </div>
            ) : (
              <div className="text-center py-10">
                <Smartphone size={48} className="mx-auto text-gray-400 mb-4" />
                <p className="text-gray-600 font-medium mb-2">您目前處於「本機模式」</p>
                <p className="text-sm text-gray-500">請先登出並切換至「雲端同步」模式，即可管理該帳號的雲端同步與刪除操作。</p>
              </div>
            )}
          </div>
        </div>
      );
    }

    // --- 輔助防呆按鈕元件 ---
    function ClearButton({ label, days, onClear }) {
      const handleClear = () => {
        const targetDate = new Date();
        targetDate.setDate(targetDate.getDate() - days);
        onClear(targetDate.toISOString());
      };
      return (
        <div className="p-2">
          <ConfirmButton initLabel={label} confirmLabel="確定清除？" onClick={handleClear} />
        </div>
      );
    }

    function ConfirmButton({ initLabel, confirmLabel, onClick, isDanger = false, disabled = false }) {
      const { t } = useContext(AppThemeContext);
      const [confirming, setConfirming] = useState(false);

      if (confirming) {
        return (
          <div className="flex gap-2 w-full">
            <button 
              disabled={disabled}
              onClick={(e) => { e.stopPropagation(); setConfirming(false); }}
              className={`flex-1 py-3 px-4 rounded-xl bg-gray-100 text-gray-700 font-medium flex justify-center items-center gap-1 transition ${disabled ? 'opacity-50 cursor-not-allowed' : 'active:bg-gray-200'}`}
            >
              <X size={18} /> 取消
            </button>
            <button 
              disabled={disabled}
              onClick={(e) => { e.stopPropagation(); onClick(); setConfirming(false); }}
              className={`flex-1 py-3 px-4 rounded-xl font-medium flex justify-center items-center gap-1 text-white shadow-sm transition
                ${isDanger ? 'bg-red-600' : t.bg}
                ${disabled ? 'opacity-50 cursor-not-allowed' : (isDanger ? 'active:bg-red-700' : t.bgActive)}
              `}
            >
              <Check size={18} /> {confirmLabel}
            </button>
          </div>
        );
      }

      return (
        <button 
          disabled={disabled}
          onClick={(e) => { e.stopPropagation(); setConfirming(true); }}
          className={`w-full py-3 px-4 rounded-xl font-medium text-left transition flex items-center justify-between
            ${isDanger ? 'text-red-600' : 'text-gray-700'}
            ${disabled ? 'opacity-50 cursor-not-allowed bg-gray-50' : (isDanger ? 'hover:bg-red-50' : 'hover:bg-gray-50')}
          `}
        >
          <span className="px-2">{initLabel}</span>
          {isDanger && <Trash2 size={18} className="mr-2" />}
        </button>
      );
    }

    // --- 7. 渲染至畫面 ---
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);

  </script>
</body>
</html>
