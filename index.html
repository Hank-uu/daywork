<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>日常紀錄小幫手</title>

  <!-- 設定網頁分頁圖示與手機桌面 App 圖示 -->
  <link rel="icon" href="./daywork.jpg" type="image/jpeg">
  <link rel="apple-touch-icon" href="./daywork.jpg">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="紀錄小幫手">

  <!-- 1. 載入 Tailwind CSS (處理畫面樣式) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- 2. 載入 React 與 ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

  <!-- 3. 載入 Babel (讓瀏覽器能即時解析 React 的 JSX 語法) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- 4. 設定 Firebase ES Modules 的 Import Map -->
  <script type="importmap">
    {
      "imports": {
        "firebase/app": "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"
      }
    }
  </script>
</head>
<body class="bg-gray-100">
  
  <div id="root"></div>

  <!-- 5. 主程式碼 -->
  <script type="text/babel" data-type="module">
    // --- 引入 Firebase ---
    import { initializeApp } from 'firebase/app';
    import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from 'firebase/auth';
    import { getFirestore, collection, doc, setDoc, deleteDoc, updateDoc, onSnapshot } from 'firebase/firestore';

    const { useState, useEffect, useMemo, createContext, useContext } = React;

    // --- 自訂 SVG 圖示 ---
    const iconsMap = {
      Plus: (
        <React.Fragment>
          <line x1="12" x2="12" y1="5" y2="19" />
          <line x1="5" x2="19" y1="12" y2="12" />
        </React.Fragment>
      ),
      ChevronLeft: <polyline points="15 18 9 12 15 6" />,
      ChevronRight: <polyline points="9 18 15 12 9 6" />,
      Trash2: (
        <React.Fragment>
          <path d="M3 6h18" />
          <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" />
          <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" />
          <line x1="10" x2="10" y1="11" y2="17" />
          <line x1="14" x2="14" y1="11" y2="17" />
        </React.Fragment>
      ),
      CalendarIcon: (
        <React.Fragment>
          <rect width="18" height="18" x="3" y="4" rx="2" ry="2" />
          <line x1="16" x2="16" y1="2" y2="6" />
          <line x1="8" x2="8" y1="2" y2="6" />
          <line x1="3" x2="21" y1="10" y2="10" />
        </React.Fragment>
      ),
      Clock: (
        <React.Fragment>
          <circle cx="12" cy="12" r="10" />
          <polyline points="12 6 12 12 16 14" />
        </React.Fragment>
      ),
      X: (
        <React.Fragment>
          <line x1="18" x2="6" y1="6" y2="18" />
          <line x1="6" x2="18" y1="6" y2="18" />
        </React.Fragment>
      ),
      Check: <polyline points="20 6 9 17 4 12" />,
      LogOut: (
        <React.Fragment>
          <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
          <polyline points="16 17 21 12 16 7" />
          <line x1="21" x2="9" y1="12" y2="12" />
        </React.Fragment>
      ),
      User: (
        <React.Fragment>
          <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2" />
          <circle cx="12" cy="7" r="4" />
        </React.Fragment>
      ),
      Cloud: <path d="M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9Z" />,
      Smartphone: (
        <React.Fragment>
          <rect width="14" height="20" x="5" y="2" rx="2" ry="2" />
          <path d="M12 18h.01" />
        </React.Fragment>
      ),
      Folder: (
        <React.Fragment>
          <path d="M4 20h16a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.93a2 2 0 0 1-1.66-.9l-.82-1.2A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13c0 1.1.9 2 2 2Z" />
        </React.Fragment>
      ),
      Settings: (
        <React.Fragment>
          <circle cx="12" cy="12" r="3" />
          <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z" />
        </React.Fragment>
      ),
      Edit2: (
        <React.Fragment>
          <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z" />
        </React.Fragment>
      ),
      Palette: (
        <React.Fragment>
          <circle cx="13.5" cy="6.5" r=".5" />
          <circle cx="17.5" cy="10.5" r=".5" />
          <circle cx="8.5" cy="7.5" r=".5" />
          <circle cx="6.5" cy="12.5" r=".5" />
          <path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.012 17.461 2 12 2z" />
        </React.Fragment>
      ),
      Target: (
        <React.Fragment>
          <circle cx="12" cy="12" r="10" />
          <circle cx="12" cy="12" r="6" />
          <circle cx="12" cy="12" r="2" />
        </React.Fragment>
      ),
      Flame: (
        <React.Fragment>
          <path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z" />
        </React.Fragment>
      ),
      Bell: (
        <React.Fragment>
          <path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9" />
          <path d="M10.3 21a1.94 1.94 0 0 0 3.4 0" />
        </React.Fragment>
      ),
      StickyNote: (
        <React.Fragment>
          <path d="M16 3H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h12l5-5V5a2 2 0 0 0-2-2z" />
          <polyline points="15 21 15 16 20 16" />
        </React.Fragment>
      )
    };

    const Icon = ({ name, size = 24, className = '', ...props }) => (
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width={size}
        height={size}
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        strokeWidth="2"
        strokeLinecap="round"
        strokeLinejoin="round"
        className={className}
        {...props}
      >
        {iconsMap[name]}
      </svg>
    );

    const Plus = (p) => <Icon name="Plus" {...p} />;
    const ChevronLeft = (p) => <Icon name="ChevronLeft" {...p} />;
    const ChevronRight = (p) => <Icon name="ChevronRight" {...p} />;
    const Trash2 = (p) => <Icon name="Trash2" {...p} />;
    const CalendarIcon = (p) => <Icon name="CalendarIcon" {...p} />;
    const Clock = (p) => <Icon name="Clock" {...p} />;
    const X = (p) => <Icon name="X" {...p} />;
    const Check = (p) => <Icon name="Check" {...p} />;
    const LogOut = (p) => <Icon name="LogOut" {...p} />;
    const User = (p) => <Icon name="User" {...p} />;
    const Cloud = (p) => <Icon name="Cloud" {...p} />;
    const Smartphone = (p) => <Icon name="Smartphone" {...p} />;
    const Folder = (p) => <Icon name="Folder" {...p} />;
    const Settings = (p) => <Icon name="Settings" {...p} />;
    const Edit2 = (p) => <Icon name="Edit2" {...p} />;
    const Palette = (p) => <Icon name="Palette" {...p} />;
    const Target = (p) => <Icon name="Target" {...p} />;
    const Flame = (p) => <Icon name="Flame" {...p} />;
    const Bell = (p) => <Icon name="Bell" {...p} />;
    const StickyNote = (p) => <Icon name="StickyNote" {...p} />;

    // --- Firebase 設定 ---
    const firebaseConfig = {
      apiKey: "AIzaSyCnQEe7z0gvsdm3lTDZWus6scdSSD6ooEU",
      authDomain: "mywork-26db5.firebaseapp.com",
      projectId: "mywork-26db5",
      storageBucket: "mywork-26db5.firebasestorage.app",
      messagingSenderId: "168509668059",
      appId: "1:168509668059:web:e80165656aabd430e02afe",
      measurementId: "G-TFX7B1E9JK"
    };
    
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const generateId = () => Math.random().toString(36).substr(2, 9);

    const INITIAL_ACTIVITIES = [
      { id: generateId(), name: '吃藥', records: [], groupId: 'default', target: 3 },
      { id: generateId(), name: '清洗冷氣濾網', records: [], groupId: 'default', target: 1 },
      { id: generateId(), name: '運動', records: [], groupId: 'default', target: 1 },
    ];

    const THEMES = {
      blue: { label: '經典藍', code: '#2563eb', bg: 'bg-blue-600', bgHover: 'hover:bg-blue-700', bgActive: 'active:bg-blue-700', bgDisabled: 'disabled:bg-blue-300', ring: 'focus:ring-blue-500', text: 'text-blue-600', textIcon: 'text-blue-500', bgLight: 'bg-blue-100', bgLightHover: 'hover:bg-blue-200', textLight: 'text-blue-700', textDark: 'text-blue-800', border: 'border-blue-600', calendarDot: 'bg-blue-500', hoverBgLight: 'hover:bg-blue-50' },
      pink: { label: '櫻花粉', code: '#ec4899', bg: 'bg-pink-600', bgHover: 'hover:bg-pink-700', bgActive: 'active:bg-pink-700', bgDisabled: 'disabled:bg-pink-300', ring: 'focus:ring-pink-500', text: 'text-pink-600', textIcon: 'text-pink-500', bgLight: 'bg-pink-100', bgLightHover: 'hover:bg-pink-200', textLight: 'text-pink-700', textDark: 'text-pink-800', border: 'border-pink-600', calendarDot: 'bg-pink-500', hoverBgLight: 'hover:bg-pink-50' },
      purple: { label: '夢幻紫', code: '#9333ea', bg: 'bg-purple-600', bgHover: 'hover:bg-purple-700', bgActive: 'active:bg-purple-700', bgDisabled: 'disabled:bg-purple-300', ring: 'focus:ring-purple-500', text: 'text-purple-600', textIcon: 'text-purple-500', bgLight: 'bg-purple-100', bgLightHover: 'hover:bg-purple-200', textLight: 'text-purple-700', textDark: 'text-purple-800', border: 'border-purple-600', calendarDot: 'bg-purple-500', hoverBgLight: 'hover:bg-purple-50' },
      green: { label: '自然綠', code: '#16a34a', bg: 'bg-green-600', bgHover: 'hover:bg-green-700', bgActive: 'active:bg-green-700', bgDisabled: 'disabled:bg-green-300', ring: 'focus:ring-green-500', text: 'text-green-600', textIcon: 'text-green-500', bgLight: 'bg-green-100', bgLightHover: 'hover:bg-green-200', textLight: 'text-green-700', textDark: 'text-green-800', border: 'border-green-600', calendarDot: 'bg-green-500', hoverBgLight: 'hover:bg-green-50' }
    };

    const AppThemeContext = createContext();

    function App() {
      const [authUser, setAuthUser] = useState(null);
      const [showSettings, setShowSettings] = useState(false);
      const [storageMode, setStorageMode] = useState(() => localStorage.getItem('tracker_storage_mode') || null);
      const [themeColor, setThemeColor] = useState(() => localStorage.getItem('tracker_theme_color') || 'blue');
      const [headerText, setHeaderText] = useState(() => localStorage.getItem('tracker_header_text') || 'text-white');
      const [activities, setActivities] = useState([]);
      const [groups, setGroups] = useState([]);
      const [isLoading, setIsLoading] = useState(true);
      const [selectedActivityId, setSelectedActivityId] = useState(null);
      const [selectedGroupId, setSelectedGroupId] = useState('default');
      const [memoTargetId, setMemoTargetId] = useState(null);

      const allGroups = useMemo(() => [{ id: 'default', name: '預設' }, ...groups], [groups]);
      const displayName = authUser ? (authUser.displayName || authUser.email) : '本機使用者';

      useEffect(() => {
        const unsubscribe = onAuthStateChanged(auth, (user) => {
          setAuthUser(user);
          if (!user && storageMode === 'cloud') { setStorageMode(null); localStorage.removeItem('tracker_storage_mode'); }
        });
        return () => unsubscribe();
      }, [storageMode]);

      useEffect(() => {
        if (storageMode === 'cloud' && authUser) {
          setIsLoading(true);
          const unsubActs = onSnapshot(collection(db, 'users', authUser.uid, 'activities'), s => {
            setActivities(s.docs.map(d => d.data()).sort((a,b)=>a.id.localeCompare(b.id)));
            setIsLoading(false);
          });
          const unsubGrps = onSnapshot(collection(db, 'users', authUser.uid, 'groups'), s => {
            setGroups(s.docs.map(d => d.data()).sort((a,b)=>a.name.localeCompare(b.name)));
          });
          return () => { unsubActs(); unsubGrps(); };
        } else if (storageMode === 'local') {
          const savedActs = localStorage.getItem('activityTrackerData_local');
          const savedGrps = localStorage.getItem('activityTrackerGroups_local');
          setActivities(savedActs ? JSON.parse(savedActs) : []);
          setGroups(savedGrps ? JSON.parse(savedGrps) : []);
          setIsLoading(false);
        }
      }, [authUser, storageMode]);

      useEffect(() => {
        if (storageMode === 'local') {
          localStorage.setItem('activityTrackerData_local', JSON.stringify(activities));
          localStorage.setItem('activityTrackerGroups_local', JSON.stringify(groups));
        }
      }, [activities, groups, storageMode]);

      // 提醒功能邏輯
      useEffect(() => {
        const interval = setInterval(() => {
          const now = new Date();
          const currentTimeStr = now.getHours().toString().padStart(2, '0') + ":" + now.getMinutes().toString().padStart(2, '0');
          activities.forEach(act => {
            if (act.reminder && act.reminder === currentTimeStr) {
              if (Notification.permission === 'granted') {
                new Notification(`提醒：該執行「${act.name}」囉！`, { icon: './daywork.jpg' });
              }
            }
          });
        }, 60000);
        return () => clearInterval(interval);
      }, [activities]);

      const themeValue = useMemo(() => ({ themeColor, t: THEMES[themeColor] || THEMES.blue, headerText, setThemeColor, setHeaderText }), [themeColor, headerText]);

      const handleAddRecord = async (id, memo = "") => {
        const act = activities.find(a => a.id === id);
        if (!act) return;
        const now = new Date().toISOString();
        const newRecord = { timestamp: now, memo: memo };
        const updatedRecords = [...act.records, newRecord];
        
        if (storageMode === 'cloud' && authUser) {
          await updateDoc(doc(db, 'users', authUser.uid, 'activities', id), { records: updatedRecords });
        } else {
          setActivities(activities.map(a => a.id === id ? { ...a, records: updatedRecords } : a));
        }
      };

      const handleUpdateActivity = async (id, data) => {
        if (storageMode === 'cloud' && authUser) {
          await updateDoc(doc(db, 'users', authUser.uid, 'activities', id), data);
        } else {
          setActivities(activities.map(a => a.id === id ? { ...a, ...data } : a));
        }
      };

      const selectedActivity = activities.find(a => a.id === selectedActivityId);

      if (!storageMode) {
        return (
          <AppThemeContext.Provider value={themeValue}>
            <div className="min-h-screen bg-gray-100 flex items-center justify-center p-4">
              <div className="bg-white p-8 rounded-2xl shadow-xl max-w-sm w-full">
                <div className="flex justify-center gap-4 mb-6">
                  <div className={`${themeValue.t.bgLight} p-4 rounded-full ${themeValue.t.text}`}><Cloud size={32} /></div>
                  <div className="bg-gray-100 p-4 rounded-full text-gray-600"><Smartphone size={32} /></div>
                </div>
                <h1 className="text-2xl font-bold text-center text-gray-800 mb-2">紀錄小幫手</h1>
                <button onClick={async () => {
                  const provider = new GoogleAuthProvider();
                  try { await signInWithPopup(auth, provider); setStorageMode('cloud'); localStorage.setItem('tracker_storage_mode', 'cloud'); Notification.requestPermission(); } catch (e) { alert(e.message); }
                }} className={`w-full ${themeValue.t.bg} text-white rounded-xl px-4 py-4 font-bold shadow-md ${themeValue.t.bgHover} transition flex items-center justify-center gap-2`}><User size={20} /> 以 Google 帳號登入</button>
                <div className="relative flex py-6 items-center"><div className="flex-grow border-t border-gray-200"></div><span className="mx-4 text-gray-400 text-sm">或</span><div className="flex-grow border-t border-gray-200"></div></div>
                <button onClick={() => { setStorageMode('local'); localStorage.setItem('tracker_storage_mode', 'local'); Notification.requestPermission(); }} className="w-full bg-gray-100 text-gray-700 rounded-xl px-4 py-3 font-bold hover:bg-gray-200 transition flex items-center justify-center gap-2"><Smartphone size={20} /> 僅在本機使用</button>
              </div>
            </div>
          </AppThemeContext.Provider>
        );
      }

      return (
        <AppThemeContext.Provider value={themeValue}>
          <div className="min-h-screen bg-gray-100 font-sans text-gray-800">
            <div className="max-w-md mx-auto bg-white min-h-screen shadow-lg flex flex-col relative overflow-hidden">
              <header className={`${themeValue.t.bg} ${themeValue.headerText} p-4 shadow-md z-10 flex items-center justify-between transition-colors duration-300`}>
                <div className="flex items-center gap-2 flex-1 overflow-hidden">
                  {storageMode === 'cloud' ? <Cloud size={20} /> : <Smartphone size={20} />}
                  <h1 className="text-xl font-bold truncate">{selectedActivity ? selectedActivity.name : (storageMode === 'cloud' ? `${displayName} 的紀錄` : '本機紀錄')}</h1>
                </div>
                {!selectedActivity && (
                  <div className="flex items-center ml-2">
                    <button onClick={() => setShowSettings(!showSettings)} className="p-2 hover:opacity-80 transition">{showSettings ? <X size={20} /> : <Settings size={20} />}</button>
                    <button onClick={() => { signOut(auth); setStorageMode(null); localStorage.removeItem('tracker_storage_mode'); }} className="p-2 hover:opacity-80 transition ml-1"><LogOut size={20} /></button>
                  </div>
                )}
              </header>

              <main className="flex-1 overflow-y-auto">
                {showSettings ? (
                  <SettingsView onBack={() => setShowSettings(false)} storageMode={storageMode} authUser={authUser} displayName={displayName} activities={activities} groups={groups} db={db} />
                ) : !selectedActivity ? (
                  <HomeView 
                    activities={activities} 
                    allGroups={allGroups} 
                    selectedGroupId={selectedGroupId} 
                    onSelectGroup={setSelectedGroupId} 
                    onAddActivity={async (name) => {
                      const id = generateId();
                      const newItem = { id, name, records: [], groupId: selectedGroupId, target: 1 };
                      if (storageMode === 'cloud') await setDoc(doc(db, 'users', authUser.uid, 'activities', id), newItem);
                      else setActivities([...activities, newItem]);
                    }}
                    onAddRecord={(id) => setMemoTargetId(id)}
                    onSelectActivity={setSelectedActivityId}
                    onLoadDefaults={async () => {
                      for(const act of INITIAL_ACTIVITIES) {
                        if (storageMode === 'cloud') await setDoc(doc(db, 'users', authUser.uid, 'activities', act.id), act);
                      }
                      if (storageMode === 'local') setActivities(INITIAL_ACTIVITIES);
                    }}
                  />
                ) : (
                  <DetailView 
                    activity={selectedActivity} 
                    allGroups={allGroups} 
                    onBack={() => setSelectedActivityId(null)} 
                    onAddRecord={() => setMemoTargetId(selectedActivity.id)}
                    onUpdateActivity={(data) => handleUpdateActivity(selectedActivity.id, data)}
                    onDeleteRecord={async (rStr) => {
                      const newRecords = selectedActivity.records.filter(r => (typeof r === 'string' ? r : r.timestamp) !== rStr);
                      await handleUpdateActivity(selectedActivity.id, { records: newRecords });
                    }}
                    onDeleteActivity={async () => {
                      setSelectedActivityId(null);
                      if (storageMode === 'cloud') await deleteDoc(doc(db, 'users', authUser.uid, 'activities', selectedActivity.id));
                      else setActivities(activities.filter(a => a.id !== selectedActivity.id));
                    }}
                  />
                )}
              </main>
              
              {memoTargetId && (
                <MemoModal 
                  onSave={(memo) => { handleAddRecord(memoTargetId, memo); setMemoTargetId(null); }}
                  onClose={() => setMemoTargetId(null)}
                />
              )}
            </div>
          </div>
        </AppThemeContext.Provider>
      );
    }

    function HomeView({ activities, allGroups, selectedGroupId, onSelectGroup, onAddActivity, onAddRecord, onSelectActivity, onLoadDefaults }) {
      const { t } = useContext(AppThemeContext);
      const [newName, setNewName] = useState('');
      const todayStr = new Date().toLocaleDateString('en-CA');
      const visible = activities.filter(a => (a.groupId || 'default') === selectedGroupId);

      const calculateStreak = (records) => {
        if (!records.length) return 0;
        const days = Array.from(new Set(records.map(r => new Date(typeof r === 'string' ? r : r.timestamp).toLocaleDateString('en-CA')))).sort().reverse();
        let streak = 0;
        let checkDate = new Date();
        for (let i = 0; i < days.length; i++) {
          const d = new Date(days[i]);
          const diff = Math.floor((checkDate - d) / (1000 * 60 * 60 * 24));
          if (diff <= 1) { streak++; checkDate = d; } else break;
        }
        return streak;
      };

      return (
        <div className="flex flex-col h-full bg-gray-50">
          <div className="flex overflow-x-auto bg-white border-b border-gray-100 items-center shadow-sm px-2">
            {allGroups.map(g => (
              <button key={g.id} onClick={() => onSelectGroup(g.id)} className={`px-5 py-3 font-medium transition-colors ${selectedGroupId === g.id ? `${t.text} border-b-2 ${t.border}` : 'text-gray-500 hover:text-gray-700'}`}>{g.name}</button>
            ))}
          </div>
          <div className="p-4 flex-1 overflow-y-auto">
            <div className="flex gap-2 mb-6">
              <input type="text" value={newName} onChange={e => setNewName(e.target.value)} placeholder="新增項目..." className={`flex-1 border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 ${t.ring} shadow-sm`} />
              <button onClick={() => { if(newName.trim()){ onAddActivity(newName.trim()); setNewName(''); }}} className={`${t.bg} text-white rounded-lg px-4 py-3 shadow-sm`}><Plus size={24} /></button>
            </div>
            <div className="space-y-3">
              {visible.map(a => {
                const todayRecs = a.records.filter(r => new Date(typeof r === 'string' ? r : r.timestamp).toLocaleDateString('en-CA') === todayStr);
                const progress = Math.min(100, (todayRecs.length / (a.target || 1)) * 100);
                const streak = calculateStreak(a.records);
                return (
                  <div key={a.id} onClick={() => onSelectActivity(a.id)} className="bg-white border border-gray-100 rounded-xl p-4 shadow-sm hover:shadow-md transition cursor-pointer">
                    <div className="flex justify-between items-start mb-2">
                      <div>
                        <h3 className="text-lg font-bold text-gray-800">{a.name}</h3>
                        <p className="text-xs text-gray-500">今日: {todayRecs.length} / 目標: {a.target || 1}</p>
                      </div>
                      <div className="flex items-center gap-2">
                        {streak > 0 && <div className="flex items-center gap-1 text-orange-500 text-sm font-bold"><Flame size={16}/>{streak}</div>}
                        <button onClick={(e) => { e.stopPropagation(); onAddRecord(a.id); }} className={`${t.bgLight} ${t.textLight} rounded-full h-10 w-10 flex items-center justify-center font-bold`}>+1</button>
                      </div>
                    </div>
                    <div className="w-full bg-gray-100 h-2 rounded-full overflow-hidden">
                      <div className={`${t.bg} h-full transition-all duration-500`} style={{ width: `${progress}%` }}></div>
                    </div>
                  </div>
                );
              })}
              {visible.length === 0 && <div className="text-center py-10 text-gray-400">這裡空空如也...</div>}
            </div>
          </div>
        </div>
      );
    }

    function MemoModal({ onSave, onClose }) {
      const { t } = useContext(AppThemeContext);
      const [memo, setMemo] = useState('');
      return (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-2xl p-6 w-full max-w-sm shadow-xl animate-in fade-in zoom-in duration-200">
            <h3 className="font-bold text-lg mb-4 flex items-center gap-2"><StickyNote size={20} className={t.textIcon}/> 新增紀錄備註</h3>
            <textarea autoFocus value={memo} onChange={e=>setMemo(e.target.value)} className={`w-full border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 ${t.ring} mb-6 h-24`} placeholder="選填：例如「飯後吃」、「剛運動完」" />
            <div className="flex gap-2">
              <button onClick={() => onSave('')} className="flex-1 px-4 py-2 text-gray-500 hover:bg-gray-100 rounded-xl transition">直接紀錄</button>
              <button onClick={() => onSave(memo)} className={`flex-1 px-4 py-2 text-white ${t.bg} rounded-xl shadow-md font-bold`}>儲存並紀錄</button>
            </div>
            <button onClick={onClose} className="absolute top-4 right-4 text-gray-400"><X size={20}/></button>
          </div>
        </div>
      );
    }

    function DetailView({ activity, allGroups, onBack, onAddRecord, onUpdateActivity, onDeleteRecord, onDeleteActivity }) {
      const { t } = useContext(AppThemeContext);
      const [currentMonth, setCurrentMonth] = useState(new Date());
      const [selectedDateStr, setSelectedDateStr] = useState(new Date().toLocaleDateString('en-CA'));

      const recordsByDate = useMemo(() => {
        const map = {};
        activity.records.forEach(r => {
          const rObj = typeof r === 'string' ? { timestamp: r, memo: '' } : r;
          const dStr = new Date(rObj.timestamp).toLocaleDateString('en-CA');
          if (!map[dStr]) map[dStr] = [];
          map[dStr].push(rObj);
        });
        return map;
      }, [activity.records]);

      const selectedDayRecords = recordsByDate[selectedDateStr] || [];

      return (
        <div className="flex flex-col h-full bg-gray-50 pb-8">
          <div className="bg-white px-4 py-3 flex items-center justify-between shadow-sm sticky top-0 z-10">
            <button onClick={onBack} className="p-2 text-gray-600 hover:bg-gray-100 rounded-full"><ChevronLeft size={24} /></button>
            <div className="text-center">
              <h2 className="font-bold text-gray-800">{activity.name}</h2>
              <p className="text-xs text-gray-500">總計 {activity.records.length} 次</p>
            </div>
            <button onClick={onAddRecord} className={`${t.text} p-2 font-bold`}>+ 記一筆</button>
          </div>

          <div className="p-4 space-y-6 overflow-y-auto">
            {/* 月曆組件 */}
            <div className="bg-white rounded-2xl p-4 shadow-sm">
              <div className="flex justify-between mb-4">
                <button onClick={() => setCurrentMonth(new Date(currentMonth.getFullYear(), currentMonth.getMonth() - 1, 1))}><ChevronLeft size={20}/></button>
                <span className="font-bold">{currentMonth.getFullYear()}年 {currentMonth.getMonth() + 1}月</span>
                <button onClick={() => setCurrentMonth(new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 1))}><ChevronRight size={20}/></button>
              </div>
              <div className="grid grid-cols-7 gap-1 text-center">
                {['日','一','二','三','四','五','六'].map(d=><div key={d} className="text-xs text-gray-400 py-1">{d}</div>)}
                {Array.from({length: new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1).getDay()}).map((_,i)=><div key={i}/>)}
                {Array.from({length: new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 0).getDate()}).map((_,i)=>{
                  const d = i + 1;
                  const dStr = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), d).toLocaleDateString('en-CA');
                  const has = recordsByDate[dStr];
                  const sel = selectedDateStr === dStr;
                  return (
                    <button key={i} onClick={()=>setSelectedDateStr(dStr)} className={`h-10 w-10 rounded-full flex flex-col items-center justify-center text-sm relative ${sel ? `${t.bg} text-white shadow-md` : 'hover:bg-gray-50'}`}>
                      {d}{has && <div className={`w-1 h-1 rounded-full mt-0.5 ${sel ? 'bg-white' : t.calendarDot}`}></div>}
                    </button>
                  );
                })}
              </div>
            </div>

            {/* 當日紀錄 */}
            <div className="bg-white rounded-2xl p-4 shadow-sm">
              <h3 className="font-bold text-gray-700 border-b pb-2 mb-4">{selectedDateStr} 紀錄</h3>
              <div className="space-y-3">
                {selectedDayRecords.length > 0 ? selectedDayRecords.sort((a,b)=>new Date(b.timestamp)-new Date(a.timestamp)).map((r,i) => (
                  <div key={i} className="flex justify-between items-center group">
                    <div className="flex gap-3">
                      <div className="text-lg font-mono">{new Date(r.timestamp).toLocaleTimeString('zh-TW', {hour:'2-digit', minute:'2-digit', hour12:false})}</div>
                      {r.memo && <div className="text-gray-500 text-sm bg-gray-100 px-2 py-0.5 rounded flex items-center gap-1"><StickyNote size={12}/>{r.memo}</div>}
                    </div>
                    <button onClick={() => onDeleteRecord(r.timestamp)} className="text-gray-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition"><Trash2 size={16}/></button>
                  </div>
                )) : <div className="text-center text-gray-400 py-4">無資料</div>}
              </div>
            </div>

            {/* 進階設定區 */}
            <div className="bg-white rounded-2xl p-4 shadow-sm space-y-4">
              <h4 className="font-bold text-sm text-gray-400 uppercase">項目設定</h4>
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-2 font-medium text-gray-700"><Target size={18} className="text-gray-400"/> 每日目標次數</div>
                <input type="number" min="1" value={activity.target || 1} onChange={e=>onUpdateActivity({target: parseInt(e.target.value)||1})} className={`w-16 border rounded px-2 py-1 focus:ring-2 ${t.ring} outline-none text-center`} />
              </div>
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-2 font-medium text-gray-700"><Bell size={18} className="text-gray-400"/> 定時提醒時間</div>
                <input type="time" value={activity.reminder || ''} onChange={e=>onUpdateActivity({reminder: e.target.value})} className={`border rounded px-2 py-1 focus:ring-2 ${t.ring} outline-none`} />
              </div>
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-2 font-medium text-gray-700"><Folder size={18} className="text-gray-400"/> 所屬群組</div>
                <select value={activity.groupId || 'default'} onChange={e=>onUpdateActivity({groupId: e.target.value})} className="border rounded px-2 py-1 outline-none">
                  {allGroups.map(g=><option key={g.id} value={g.id}>{g.name}</option>)}
                </select>
              </div>
              <div className="pt-4 border-t space-y-2">
                <button onClick={onDeleteActivity} className="w-full py-3 text-red-500 font-bold hover:bg-red-50 rounded-xl transition flex items-center justify-center gap-2"><Trash2 size={18}/> 刪除此追蹤項目</button>
              </div>
            </div>
          </div>
        </div>
      );
    }

    function SettingsView({ onBack, storageMode, authUser, displayName, activities, groups, db }) {
      const { t, themeColor, headerText, setThemeColor, setHeaderText } = useContext(AppThemeContext);
      const colors = [{label:'純白',val:'text-white',c:'#fff'}, {label:'深黑',val:'text-gray-900',c:'#111'}, {label:'亮黃',val:'text-yellow-300',c:'#ff0'}];
      return (
        <div className="p-4 space-y-6">
          <button onClick={onBack} className="flex items-center gap-1 text-gray-500"><ChevronLeft size={20}/> 返回</button>
          <div className="bg-white rounded-2xl p-4 shadow-sm space-y-6">
            <h3 className="font-bold text-lg flex items-center gap-2"><Palette size={20}/> 外觀設定</h3>
            <div>
              <p className="text-sm text-gray-500 mb-3">主題色彩：</p>
              <div className="flex gap-4">
                {Object.entries(THEMES).map(([k,v]) => <button key={k} onClick={()=>setThemeColor(k)} className={`w-10 h-10 rounded-full border-4 ${themeColor===k ? 'border-gray-800 shadow-lg' : 'border-transparent'}`} style={{backgroundColor:v.code}}></button>)}
              </div>
            </div>
            <div>
              <p className="text-sm text-gray-500 mb-3">文字顏色：</p>
              <div className="flex gap-4">
                {colors.map(c => <button key={c.val} onClick={()=>setHeaderText(c.val)} className={`px-3 py-1 rounded-lg border-2 ${headerText===c.val ? 'border-gray-800' : 'border-gray-200'}`} style={{color:c.c==='#fff'?'#000':c.c}}>{c.label}</button>)}
              </div>
            </div>
          </div>
          {storageMode === 'cloud' && (
            <div className="bg-white rounded-2xl p-4 shadow-sm space-y-4">
              <h3 className="font-bold text-lg flex items-center gap-2"><Cloud size={20}/> 雲端帳戶</h3>
              <p className="text-sm text-blue-600 font-bold">{displayName}</p>
              <p className="text-xs text-gray-400">您的紀錄會自動在不同裝置間同步。</p>
            </div>
          )}
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
