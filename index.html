<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>日常紀錄小幫手</title>

  <!-- 1. 載入 Tailwind CSS (處理畫面樣式) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- 2. 載入 React 與 ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

  <!-- 3. 載入 Babel (讓瀏覽器能即時解析 React 的 JSX 語法) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- 4. 設定 Firebase ES Modules 的 Import Map -->
  <script type="importmap">
    {
      "imports": {
        "firebase/app": "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"
      }
    }
  </script>
</head>
<body class="bg-gray-100">
  
  <!-- React 應用程式的掛載點 -->
  <div id="root"></div>

  <!-- 5. 主程式碼 (type="text/babel" data-type="module" 支援 import 功能) -->
  <script type="text/babel" data-type="module">
    // --- 引入 Firebase ---
    import { initializeApp } from 'firebase/app';
    import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'firebase/auth';
    import { getFirestore, collection, doc, setDoc, deleteDoc, updateDoc, onSnapshot } from 'firebase/firestore';

    // --- 從全域變數提取 React Hooks ---
    const { useState, useEffect, useMemo } = React;

    // --- 自訂 SVG 圖示 (取代外部 lucide-react 腳本以避免 CDN 載入順序錯誤) ---
    const iconsMap = {
      Plus: (
        <React.Fragment>
          <line x1="12" x2="12" y1="5" y2="19" />
          <line x1="5" x2="19" y1="12" y2="12" />
        </React.Fragment>
      ),
      ChevronLeft: <polyline points="15 18 9 12 15 6" />,
      ChevronRight: <polyline points="9 18 15 12 9 6" />,
      Trash2: (
        <React.Fragment>
          <path d="M3 6h18" />
          <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" />
          <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" />
          <line x1="10" x2="10" y1="11" y2="17" />
          <line x1="14" x2="14" y1="11" y2="17" />
        </React.Fragment>
      ),
      CalendarIcon: (
        <React.Fragment>
          <rect width="18" height="18" x="3" y="4" rx="2" ry="2" />
          <line x1="16" x2="16" y1="2" y2="6" />
          <line x1="8" x2="8" y1="2" y2="6" />
          <line x1="3" x2="21" y1="10" y2="10" />
        </React.Fragment>
      ),
      Clock: (
        <React.Fragment>
          <circle cx="12" cy="12" r="10" />
          <polyline points="12 6 12 12 16 14" />
        </React.Fragment>
      ),
      X: (
        <React.Fragment>
          <line x1="18" x2="6" y1="6" y2="18" />
          <line x1="6" x2="18" y1="6" y2="18" />
        </React.Fragment>
      ),
      Check: <polyline points="20 6 9 17 4 12" />,
      LogOut: (
        <React.Fragment>
          <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
          <polyline points="16 17 21 12 16 7" />
          <line x1="21" x2="9" y1="12" y2="12" />
        </React.Fragment>
      ),
      User: (
        <React.Fragment>
          <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2" />
          <circle cx="12" cy="7" r="4" />
        </React.Fragment>
      ),
      Cloud: <path d="M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9Z" />,
      Smartphone: (
        <React.Fragment>
          <rect width="14" height="20" x="5" y="2" rx="2" ry="2" />
          <path d="M12 18h.01" />
        </React.Fragment>
      ),
      Settings: (
        <React.Fragment>
          <circle cx="12" cy="12" r="3" />
          <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z" />
        </React.Fragment>
      )
    };

    const Icon = ({ name, size = 24, className = '', ...props }) => (
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width={size}
        height={size}
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        strokeWidth="2"
        strokeLinecap="round"
        strokeLinejoin="round"
        className={className}
        {...props}
      >
        {iconsMap[name]}
      </svg>
    );

    const Plus = (p) => <Icon name="Plus" {...p} />;
    const ChevronLeft = (p) => <Icon name="ChevronLeft" {...p} />;
    const ChevronRight = (p) => <Icon name="ChevronRight" {...p} />;
    const Trash2 = (p) => <Icon name="Trash2" {...p} />;
    const CalendarIcon = (p) => <Icon name="CalendarIcon" {...p} />;
    const Clock = (p) => <Icon name="Clock" {...p} />;
    const X = (p) => <Icon name="X" {...p} />;
    const Check = (p) => <Icon name="Check" {...p} />;
    const LogOut = (p) => <Icon name="LogOut" {...p} />;
    const User = (p) => <Icon name="User" {...p} />;
    const Cloud = (p) => <Icon name="Cloud" {...p} />;
    const Smartphone = (p) => <Icon name="Smartphone" {...p} />;
    const Settings = (p) => <Icon name="Settings" {...p} />;

    // --- Firebase 設定 ---
    // 預設給一組 dummy 設定以確保「本機模式」在沒有配置檔時不會崩潰
    const firebaseConfig = typeof __firebase_config !== 'undefined' 
        ? JSON.parse(__firebase_config) 
        : { apiKey: "dummy", projectId: "dummy", appId: "dummy" }; 
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    // --- 工具函式 ---
    const generateId = () => Math.random().toString(36).substr(2, 9);

    const INITIAL_ACTIVITIES = [
      { id: generateId(), name: '吃藥', records: [] },
      { id: generateId(), name: '清洗冷氣濾網', records: [] },
      { id: generateId(), name: '運動', records: [] },
    ];

    // ==========================================
    // Main App Component
    // ==========================================
    function App() {
      const [authUser, setAuthUser] = useState(null);
      const [usernameInput, setUsernameInput] = useState('');
      const [showSettings, setShowSettings] = useState(false);
      
      const [storageMode, setStorageMode] = useState(() => localStorage.getItem('tracker_storage_mode') || null);
      const [currentUser, setCurrentUser] = useState(() => localStorage.getItem('tracker_username') || '');
      
      const [activities, setActivities] = useState([]);
      const [isLoading, setIsLoading] = useState(true);
      const [newActivityName, setNewActivityName] = useState('');
      const [selectedActivityId, setSelectedActivityId] = useState(null);

      useEffect(() => {
        const initAuth = async () => {
          try {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
              await signInWithCustomToken(auth, __initial_auth_token);
            } else {
              await signInAnonymously(auth);
            }
          } catch (error) {
            console.warn("Firebase 未設定或連線失敗，雲端模式可能無法使用。");
          }
        };
        initAuth();
        const unsubscribe = onAuthStateChanged(auth, setAuthUser);
        return () => unsubscribe();
      }, []);

      useEffect(() => {
        if (storageMode === 'cloud') {
          if (!authUser || !currentUser) {
            setIsLoading(false);
            return;
          }
          setIsLoading(true);
          const safeUsername = currentUser.replace(/\//g, '_');
          const colRef = collection(db, 'artifacts', appId, 'public', 'data', `activities_${safeUsername}`);
          
          const unsubscribe = onSnapshot(colRef, (snapshot) => {
            const data = snapshot.docs.map(doc => doc.data());
            data.sort((a, b) => a.id.localeCompare(b.id)); 
            setActivities(data);
            setIsLoading(false);
          }, (error) => {
            console.error("Firestore error:", error);
            setIsLoading(false);
          });

          return () => unsubscribe();
        } 
        
        if (storageMode === 'local') {
          const saved = localStorage.getItem('activityTrackerData_local') || localStorage.getItem('activityTrackerData');
          if (saved) {
            try {
              setActivities(JSON.parse(saved));
            } catch (e) {
              setActivities([]);
            }
          } else {
            setActivities([]);
          }
          setIsLoading(false);
        }
      }, [authUser, currentUser, storageMode]);

      useEffect(() => {
        if (storageMode === 'local') {
          localStorage.setItem('activityTrackerData_local', JSON.stringify(activities));
        }
      }, [activities, storageMode]);

      const handleLoginCloud = (e) => {
        e.preventDefault();
        const name = usernameInput.trim();
        if (name) {
          setCurrentUser(name);
          setStorageMode('cloud');
          localStorage.setItem('tracker_username', name);
          localStorage.setItem('tracker_storage_mode', 'cloud');
          setUsernameInput('');
        }
      };

      const handleLoginLocal = () => {
        setStorageMode('local');
        localStorage.setItem('tracker_storage_mode', 'local');
      };

      const handleLogout = () => {
        setCurrentUser('');
        setStorageMode(null);
        localStorage.removeItem('tracker_username');
        localStorage.removeItem('tracker_storage_mode');
        setActivities([]);
        setSelectedActivityId(null);
      };

      const loadDefaultActivities = async () => {
        setIsLoading(true);
        if (storageMode === 'cloud' && currentUser) {
          try {
            const safeUsername = currentUser.replace(/\//g, '_');
            for (const act of INITIAL_ACTIVITIES) {
              const docRef = doc(db, 'artifacts', appId, 'public', 'data', `activities_${safeUsername}`, act.id);
              await setDoc(docRef, act);
            }
          } catch (error) {
            console.error("Error loading defaults:", error);
          }
        } else if (storageMode === 'local') {
          setActivities(INITIAL_ACTIVITIES);
        }
        setIsLoading(false);
      };

      const handleAddActivity = async (e) => {
        e.preventDefault();
        if (!newActivityName.trim()) return;
        const newId = generateId();
        const newActivity = { id: newId, name: newActivityName.trim(), records: [] };

        if (storageMode === 'cloud' && currentUser) {
          const safeUsername = currentUser.replace(/\//g, '_');
          const docRef = doc(db, 'artifacts', appId, 'public', 'data', `activities_${safeUsername}`, newId);
          await setDoc(docRef, newActivity);
        } else if (storageMode === 'local') {
          setActivities(prev => [...prev, newActivity]);
        }
        setNewActivityName('');
      };

      const handleAddRecord = async (id, e) => {
        if (e) e.stopPropagation();
        
        const activity = activities.find(a => a.id === id);
        if (!activity) return;
        const now = new Date().toISOString();

        if (storageMode === 'cloud' && currentUser) {
          const safeUsername = currentUser.replace(/\//g, '_');
          const docRef = doc(db, 'artifacts', appId, 'public', 'data', `activities_${safeUsername}`, id);
          await updateDoc(docRef, { records: [...activity.records, now] });
        } else if (storageMode === 'local') {
          setActivities(prev => prev.map(act => 
            act.id === id ? { ...act, records: [...act.records, now] } : act
          ));
        }
      };

      const handleDeleteActivity = async (id) => {
        if (storageMode === 'cloud' && currentUser) {
          const safeUsername = currentUser.replace(/\//g, '_');
          const docRef = doc(db, 'artifacts', appId, 'public', 'data', `activities_${safeUsername}`, id);
          await deleteDoc(docRef);
        } else if (storageMode === 'local') {
          setActivities(prev => prev.filter(act => act.id !== id));
        }
        setSelectedActivityId(null);
      };

      const handleClearRecords = async (id, beforeDateStr) => {
        const activity = activities.find(a => a.id === id);
        if (!activity) return;

        const cutoffTime = new Date(beforeDateStr).getTime();
        const filteredRecords = activity.records.filter(r => new Date(r).getTime() >= cutoffTime);
        
        if (storageMode === 'cloud' && currentUser) {
          const safeUsername = currentUser.replace(/\//g, '_');
          const docRef = doc(db, 'artifacts', appId, 'public', 'data', `activities_${safeUsername}`, id);
          await updateDoc(docRef, { records: filteredRecords });
        } else if (storageMode === 'local') {
          setActivities(prev => prev.map(act => 
            act.id === id ? { ...act, records: filteredRecords } : act
          ));
        }
      };

      const selectedActivity = activities.find(a => a.id === selectedActivityId);

      if (!storageMode) {
        return (
          <div className="min-h-screen bg-gray-100 flex items-center justify-center font-sans p-4">
            <div className="bg-white p-8 rounded-2xl shadow-xl max-w-sm w-full">
              <div className="flex justify-center gap-4 mb-6">
                <div className="bg-blue-100 p-4 rounded-full text-blue-600">
                  <Cloud size={32} />
                </div>
                <div className="bg-gray-100 p-4 rounded-full text-gray-600">
                  <Smartphone size={32} />
                </div>
              </div>
              <h1 className="text-2xl font-bold text-center text-gray-800 mb-2">紀錄小幫手</h1>
              <p className="text-center text-gray-500 mb-8 text-sm">請選擇您的使用方式</p>
              
              <form onSubmit={handleLoginCloud} className="space-y-4">
                <div>
                  <input
                    type="text"
                    value={usernameInput}
                    onChange={(e) => setUsernameInput(e.target.value)}
                    placeholder="輸入名稱 (雲端同步使用)"
                    className="w-full border border-gray-300 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 transition shadow-sm"
                  />
                </div>
                <button
                  type="submit"
                  disabled={!usernameInput.trim()}
                  className="w-full bg-blue-600 text-white rounded-xl px-4 py-3 font-bold shadow-md hover:bg-blue-700 disabled:bg-blue-300 transition"
                >
                  啟用雲端同步
                </button>
              </form>

              <div className="relative flex py-6 items-center">
                <div className="flex-grow border-t border-gray-200"></div>
                <span className="flex-shrink-0 mx-4 text-gray-400 text-sm">或</span>
                <div className="flex-grow border-t border-gray-200"></div>
              </div>

              <button
                onClick={handleLoginLocal}
                className="w-full bg-gray-100 text-gray-700 rounded-xl px-4 py-3 font-bold shadow-sm hover:bg-gray-200 transition flex items-center justify-center gap-2"
              >
                <Smartphone size={20} />
                僅在本機使用 (免網路)
              </button>
            </div>
          </div>
        );
      }

      if (isLoading && activities.length === 0) {
        return (
          <div className="min-h-screen bg-gray-100 flex items-center justify-center">
            <div className="animate-spin rounded-full h-12 w-12 border-4 border-blue-500 border-t-transparent"></div>
          </div>
        );
      }

      return (
        <div className="min-h-screen bg-gray-100 font-sans text-gray-800">
          <div className="max-w-md mx-auto bg-white min-h-screen shadow-lg flex flex-col relative overflow-hidden">
            
            <header className="bg-blue-600 text-white p-4 shadow-md z-10 flex items-center justify-between">
              <div className="flex items-center gap-2 flex-1 overflow-hidden">
                {storageMode === 'cloud' ? <Cloud size={20} /> : <Smartphone size={20} />}
                <h1 className="text-xl font-bold truncate">
                  {selectedActivity 
                    ? selectedActivity.name 
                    : (storageMode === 'cloud' ? `${currentUser} 的雲端紀錄` : '本機紀錄')}
                </h1>
              </div>
              {!selectedActivityId && (
                <div className="flex items-center ml-2">
                  <button onClick={() => setShowSettings(!showSettings)} className="p-2 hover:bg-blue-700 rounded-full transition" title="設定與同步">
                    {showSettings ? <X size={20} /> : <Settings size={20} />}
                  </button>
                  <button onClick={handleLogout} className="p-2 hover:bg-blue-700 rounded-full transition ml-1" title="切換模式或帳號">
                    <LogOut size={20} />
                  </button>
                </div>
              )}
            </header>

            <main className="flex-1 overflow-y-auto">
              {showSettings ? (
                <SettingsView 
                  onBack={() => setShowSettings(false)}
                  storageMode={storageMode}
                  currentUser={currentUser}
                  activities={activities}
                  db={db}
                  appId={appId}
                />
              ) : !selectedActivityId ? (
                <HomeView 
                  activities={activities}
                  newActivityName={newActivityName}
                  setNewActivityName={setNewActivityName}
                  onAddActivity={handleAddActivity}
                  onAddRecord={handleAddRecord}
                  onSelectActivity={setSelectedActivityId}
                  onLoadDefaults={loadDefaultActivities}
                />
              ) : (
                <DetailView 
                  activity={selectedActivity}
                  onBack={() => setSelectedActivityId(null)}
                  onAddRecord={() => handleAddRecord(selectedActivity.id)}
                  onClearRecords={(date) => handleClearRecords(selectedActivity.id, date)}
                  onDeleteActivity={() => handleDeleteActivity(selectedActivity.id)}
                />
              )}
            </main>
          </div>
        </div>
      );
    }

    // ==========================================
    // Home View Component
    // ==========================================
    function HomeView({ activities, newActivityName, setNewActivityName, onAddActivity, onAddRecord, onSelectActivity, onLoadDefaults }) {
      return (
        <div className="p-4 flex flex-col h-full">
          <form onSubmit={onAddActivity} className="flex gap-2 mb-6">
            <input 
              type="text" 
              value={newActivityName}
              onChange={(e) => setNewActivityName(e.target.value)}
              placeholder="輸入新追蹤項目 (例: 喝水)" 
              className="flex-1 border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 text-lg shadow-sm"
            />
            <button 
              type="submit" 
              disabled={!newActivityName.trim()}
              className="bg-blue-600 text-white rounded-lg px-4 py-3 disabled:bg-blue-300 active:bg-blue-700 transition flex items-center shadow-sm"
            >
              <Plus size={24} />
            </button>
          </form>

          <div className="flex-1 space-y-3">
            {activities.map(activity => (
              <div 
                key={activity.id} 
                onClick={() => onSelectActivity(activity.id)}
                className="bg-white border border-gray-100 rounded-xl p-4 shadow-sm hover:shadow-md transition cursor-pointer flex items-center justify-between group"
              >
                <div className="flex-1">
                  <h3 className="text-lg font-semibold text-gray-800">{activity.name}</h3>
                  <p className="text-sm text-gray-500 mt-1">
                    總計: <span className="font-bold text-blue-600">{activity.records.length}</span> 次
                  </p>
                </div>
                <button 
                  onClick={(e) => onAddRecord(activity.id, e)}
                  className="ml-4 bg-blue-100 text-blue-700 hover:bg-blue-200 rounded-full h-12 w-12 flex items-center justify-center font-bold text-lg transition-colors shadow-sm active:scale-95"
                >
                  +1
                </button>
              </div>
            ))}

            {activities.length === 0 && (
              <div className="text-center py-10 flex flex-col items-center">
                <p className="text-gray-400 mb-4">目前沒有任何項目，請在上方新增！</p>
                {onLoadDefaults && (
                  <button 
                    onClick={onLoadDefaults}
                    className="bg-blue-100 text-blue-700 px-6 py-2 rounded-xl font-bold shadow-sm hover:bg-blue-200 transition"
                  >
                    或點此載入預設項目
                  </button>
                )}
              </div>
            )}
          </div>
        </div>
      );
    }

    // ==========================================
    // Detail & Calendar View Component
    // ==========================================
    function DetailView({ activity, onBack, onAddRecord, onClearRecords, onDeleteActivity }) {
      const [currentMonth, setCurrentMonth] = useState(new Date());
      const [selectedDateStr, setSelectedDateStr] = useState(
        new Date().toLocaleDateString('en-CA') 
      );

      const year = currentMonth.getFullYear();
      const month = currentMonth.getMonth();
      const firstDayOfMonth = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();

      const recordsByDate = useMemo(() => {
        const map = {};
        activity.records.forEach(r => {
          const dateObj = new Date(r);
          const dateStr = dateObj.toLocaleDateString('en-CA');
          if (!map[dateStr]) map[dateStr] = [];
          map[dateStr].push(dateObj);
        });
        Object.keys(map).forEach(k => {
          map[k].sort((a, b) => b - a);
        });
        return map;
      }, [activity.records]);

      const handlePrevMonth = () => setCurrentMonth(new Date(year, month - 1, 1));
      const handleNextMonth = () => setCurrentMonth(new Date(year, month + 1, 1));

      const calendarDays = [];
      for (let i = 0; i < firstDayOfMonth; i++) calendarDays.push(null);
      for (let i = 1; i <= daysInMonth; i++) calendarDays.push(i);

      const selectedDayRecords = recordsByDate[selectedDateStr] || [];

      return (
        <div className="flex flex-col h-full bg-gray-50 pb-8">
          <div className="bg-white px-4 py-3 flex items-center justify-between shadow-sm sticky top-0 z-10">
            <button onClick={onBack} className="text-gray-600 hover:bg-gray-100 p-2 rounded-full transition">
              <ChevronLeft size={24} />
            </button>
            <div className="flex-1 text-center font-bold text-lg text-gray-800">
              總計 {activity.records.length} 次
            </div>
            <button onClick={onAddRecord} className="text-blue-600 hover:bg-blue-50 p-2 rounded-full transition font-bold flex items-center gap-1">
              <Plus size={20} /> 記一筆
            </button>
          </div>

          <div className="p-4 space-y-6 flex-1 overflow-y-auto">
            <div className="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
              <div className="flex justify-between items-center p-4 bg-gray-50 border-b border-gray-100">
                <button onClick={handlePrevMonth} className="p-1 hover:bg-gray-200 rounded-full"><ChevronLeft size={20} /></button>
                <h2 className="font-bold text-lg">{year} 年 {month + 1} 月</h2>
                <button onClick={handleNextMonth} className="p-1 hover:bg-gray-200 rounded-full"><ChevronRight size={20} /></button>
              </div>

              <div className="grid grid-cols-7 text-center text-xs font-semibold text-gray-500 py-2 bg-white">
                <div>日</div><div>一</div><div>二</div><div>三</div><div>四</div><div>五</div><div>六</div>
              </div>

              <div className="grid grid-cols-7 text-center bg-white pb-2">
                {calendarDays.map((day, idx) => {
                  if (!day) return <div key={`empty-${idx}`} className="py-2"></div>;
                  
                  const dateStr = new Date(year, month, day).toLocaleDateString('en-CA');
                  const hasRecord = !!recordsByDate[dateStr];
                  const isSelected = selectedDateStr === dateStr;
                  const isToday = dateStr === new Date().toLocaleDateString('en-CA');

                  return (
                    <div key={day} className="py-1 px-1 flex justify-center">
                      <button 
                        onClick={() => setSelectedDateStr(dateStr)}
                        className={`w-10 h-10 rounded-full flex flex-col items-center justify-center relative transition-all
                          ${isSelected ? 'bg-blue-600 text-white shadow-md' : 'hover:bg-gray-100'}
                          ${isToday && !isSelected ? 'border border-blue-600 text-blue-600' : ''}
                          ${!isSelected && !isToday ? 'text-gray-700' : ''}
                        `}
                      >
                        <span className="text-sm">{day}</span>
                        {hasRecord && (
                          <span className={`w-1.5 h-1.5 rounded-full mt-0.5 ${isSelected ? 'bg-white' : 'bg-blue-500'}`}></span>
                        )}
                      </button>
                    </div>
                  );
                })}
              </div>
            </div>

            <div className="bg-white rounded-2xl shadow-sm border border-gray-100 p-4">
              <h3 className="font-bold flex items-center gap-2 text-gray-700 mb-4 border-b pb-2">
                <CalendarIcon size={18} />
                {selectedDateStr} 紀錄
                <span className="ml-auto text-sm font-normal text-gray-500">
                  共 {selectedDayRecords.length} 次
                </span>
              </h3>

              {selectedDayRecords.length > 0 ? (
                <ul className="space-y-3">
                  {selectedDayRecords.map((dateObj, idx) => (
                    <li key={idx} className="flex items-center gap-3 bg-gray-50 p-3 rounded-lg text-gray-700">
                      <Clock size={16} className="text-blue-500" />
                      <span className="font-medium text-lg">
                        {dateObj.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit', second: '2-digit' })}
                      </span>
                    </li>
                  ))}
                </ul>
              ) : (
                <div className="text-center text-gray-400 py-6">這天沒有紀錄唷！</div>
              )}
            </div>

            <div className="pt-6 border-t border-gray-200">
              <h4 className="text-sm font-bold text-gray-400 uppercase tracking-wider mb-3 px-2">資料管理</h4>
              <div className="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden divide-y divide-gray-100">
                <ClearButton label="清除一週前的紀錄" days={7} onClear={onClearRecords} />
                <ClearButton label="清除一個月前的紀錄" days={30} onClear={onClearRecords} />
                <ClearButton label="清除一年前的紀錄" days={365} onClear={onClearRecords} />
                <div className="p-2">
                  <ConfirmButton initLabel="刪除此追蹤項目" confirmLabel="確定刪除？(無法復原)" onClick={onDeleteActivity} isDanger={true} />
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    }

    // ==========================================
    // Settings & Sync View Component
    // ==========================================
    function SettingsView({ onBack, storageMode, currentUser, activities, db, appId }) {
      const [statusMsg, setStatusMsg] = useState('');
      const [isProcessing, setIsProcessing] = useState(false);

      const showMessage = (msg) => {
        setStatusMsg(msg);
        setTimeout(() => setStatusMsg(''), 4000);
      };

      const handleLocalToCloud = async () => {
        setIsProcessing(true);
        try {
          const localData = JSON.parse(localStorage.getItem('activityTrackerData_local') || '[]');
          const safeUsername = currentUser.replace(/\//g, '_');
          const colPath = `activities_${safeUsername}`;

          // 清空目前雲端紀錄
          for (const act of activities) {
             await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', colPath, act.id));
          }
          // 寫入本機紀錄到雲端
          for (const act of localData) {
             await setDoc(doc(db, 'artifacts', appId, 'public', 'data', colPath, act.id), act);
          }
          showMessage('✅ 已成功將「本機紀錄」上傳並覆蓋「雲端」！');
        } catch (e) {
          showMessage('❌ 同步失敗，請稍後再試。');
        }
        setIsProcessing(false);
      };

      const handleCloudToLocal = async () => {
        setIsProcessing(true);
        try {
          localStorage.setItem('activityTrackerData_local', JSON.stringify(activities));
          showMessage('✅ 已成功將「雲端紀錄」下載並覆蓋「本機」！');
        } catch (e) {
          showMessage('❌ 同步失敗，請稍後再試。');
        }
        setIsProcessing(false);
      };

      const handleDeleteCloud = async () => {
        setIsProcessing(true);
        try {
          const safeUsername = currentUser.replace(/\//g, '_');
          const colPath = `activities_${safeUsername}`;
          for (const act of activities) {
             await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', colPath, act.id));
          }
          showMessage('✅ 已成功刪除所有雲端紀錄！');
        } catch (e) {
          showMessage('❌ 刪除失敗，請稍後再試。');
        }
        setIsProcessing(false);
      };

      return (
        <div className="flex flex-col h-full bg-gray-50 pb-8">
          <div className="bg-white px-4 py-3 flex items-center shadow-sm sticky top-0 z-10">
            <button onClick={onBack} className="text-gray-600 hover:bg-gray-100 p-2 rounded-full transition mr-2">
              <ChevronLeft size={24} />
            </button>
            <h2 className="font-bold text-lg text-gray-800">資料同步與設定</h2>
          </div>

          <div className="p-4 space-y-6 flex-1 overflow-y-auto">
            {statusMsg && (
              <div className="bg-blue-100 text-blue-800 p-3 rounded-xl text-center font-medium animate-pulse">
                {statusMsg}
              </div>
            )}

            {storageMode === 'cloud' ? (
              <div className="space-y-6">
                <div className="bg-white rounded-2xl shadow-sm border border-gray-100 p-4">
                   <h3 className="font-bold text-gray-700 mb-2 flex items-center gap-2">
                     <Cloud size={20} className="text-blue-500"/> 雲端同步管理
                   </h3>
                   <p className="text-sm text-gray-500 mb-4">目前管理帳戶：<span className="font-bold text-blue-600">{currentUser}</span></p>

                   <div className="space-y-3 divide-y divide-gray-100">
                     <div className="py-3">
                       <p className="text-sm text-gray-600 mb-2">將暫存的本機資料，上傳並覆蓋此帳戶的雲端紀錄。</p>
                       <ConfirmButton 
                          initLabel="上傳：以「本機」覆蓋「雲端」" 
                          confirmLabel="確定上傳並覆蓋？" 
                          onClick={handleLocalToCloud}
                          disabled={isProcessing}
                       />
                     </div>
                     <div className="py-3">
                       <p className="text-sm text-gray-600 mb-2">將此帳戶的雲端紀錄，下載並覆蓋到這台裝置的本機紀錄。</p>
                       <ConfirmButton 
                          initLabel="下載：以「雲端」覆蓋「本機」" 
                          confirmLabel="確定下載並覆蓋？" 
                          onClick={handleCloudToLocal}
                          disabled={isProcessing}
                       />
                     </div>
                     <div className="py-3">
                       <p className="text-sm text-red-500 mb-2">永久清空此雲端帳戶的所有紀錄 (不影響本機)。</p>
                       <ConfirmButton 
                          initLabel="刪除所有雲端紀錄" 
                          confirmLabel="確定永久刪除？" 
                          onClick={handleDeleteCloud} 
                          isDanger={true}
                          disabled={isProcessing}
                       />
                     </div>
                   </div>
                </div>
              </div>
            ) : (
              <div className="text-center py-10">
                <Smartphone size={48} className="mx-auto text-gray-400 mb-4" />
                <p className="text-gray-600 font-medium mb-2">您目前處於「本機模式」</p>
                <p className="text-sm text-gray-500">請先登出並切換至「雲端同步」模式，即可管理該帳號的雲端同步與刪除操作。</p>
              </div>
            )}
          </div>
        </div>
      );
    }

    // --- 輔助防呆按鈕元件 ---
    function ClearButton({ label, days, onClear }) {
      const handleClear = () => {
        const targetDate = new Date();
        targetDate.setDate(targetDate.getDate() - days);
        onClear(targetDate.toISOString());
      };
      return (
        <div className="p-2">
          <ConfirmButton initLabel={label} confirmLabel="確定清除？" onClick={handleClear} />
        </div>
      );
    }

    function ConfirmButton({ initLabel, confirmLabel, onClick, isDanger = false, disabled = false }) {
      const [confirming, setConfirming] = useState(false);

      if (confirming) {
        return (
          <div className="flex gap-2 w-full">
            <button 
              disabled={disabled}
              onClick={(e) => { e.stopPropagation(); setConfirming(false); }}
              className={`flex-1 py-3 px-4 rounded-xl bg-gray-100 text-gray-700 font-medium flex justify-center items-center gap-1 transition ${disabled ? 'opacity-50 cursor-not-allowed' : 'active:bg-gray-200'}`}
            >
              <X size={18} /> 取消
            </button>
            <button 
              disabled={disabled}
              onClick={(e) => { e.stopPropagation(); onClick(); setConfirming(false); }}
              className={`flex-1 py-3 px-4 rounded-xl font-medium flex justify-center items-center gap-1 text-white shadow-sm transition
                ${isDanger ? 'bg-red-600' : 'bg-blue-600'}
                ${disabled ? 'opacity-50 cursor-not-allowed' : (isDanger ? 'active:bg-red-700' : 'active:bg-blue-700')}
              `}
            >
              <Check size={18} /> {confirmLabel}
            </button>
          </div>
        );
      }

      return (
        <button 
          disabled={disabled}
          onClick={(e) => { e.stopPropagation(); setConfirming(true); }}
          className={`w-full py-3 px-4 rounded-xl font-medium text-left transition flex items-center justify-between
            ${isDanger ? 'text-red-600' : 'text-gray-700'}
            ${disabled ? 'opacity-50 cursor-not-allowed bg-gray-50' : (isDanger ? 'hover:bg-red-50' : 'hover:bg-gray-50')}
          `}
        >
          {initLabel}
          {isDanger && <Trash2 size={18} />}
        </button>
      );
    }

    // --- 7. 渲染至畫面 ---
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);

  </script>
</body>
</html>
