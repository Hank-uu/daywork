import React, { useState, useEffect, useMemo } from 'react';
import { 
  Plus, 
  ChevronLeft, 
  ChevronRight, 
  Trash2, 
  Calendar as CalendarIcon, 
  Clock, 
  X,
  Check,
  LogOut,
  User,
  Cloud,
  Smartphone
} from 'lucide-react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'firebase/auth';
import { getFirestore, collection, doc, setDoc, deleteDoc, updateDoc, onSnapshot } from 'firebase/firestore';

// --- Firebase Setup ---
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

// --- Utility Functions ---
const generateId = () => Math.random().toString(36).substr(2, 9);

const INITIAL_ACTIVITIES = [
  { id: generateId(), name: '吃藥', records: [] },
  { id: generateId(), name: '清洗冷氣濾網', records: [] },
  { id: generateId(), name: '運動', records: [] },
];

export default function App() {
  // --- Auth & User State ---
  const [authUser, setAuthUser] = useState(null);
  const [usernameInput, setUsernameInput] = useState('');
  
  // 新增 storageMode 來判斷使用者選擇: 'cloud' 或 'local'
  const [storageMode, setStorageMode] = useState(() => localStorage.getItem('tracker_storage_mode') || null);
  const [currentUser, setCurrentUser] = useState(() => localStorage.getItem('tracker_username') || '');
  
  // --- App State ---
  const [activities, setActivities] = useState([]);
  const [isLoading, setIsLoading] = useState(true);
  const [newActivityName, setNewActivityName] = useState('');
  const [selectedActivityId, setSelectedActivityId] = useState(null);

  // --- Firebase Auth Effect ---
  useEffect(() => {
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (error) {
        console.error("Auth error:", error);
      }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, setAuthUser);
    return () => unsubscribe();
  }, []);

  // --- Data Fetching Effect (Cloud & Local) ---
  useEffect(() => {
    // 雲端模式
    if (storageMode === 'cloud') {
      if (!authUser || !currentUser) {
        setIsLoading(false);
        return;
      }
      setIsLoading(true);
      const safeUsername = currentUser.replace(/\//g, '_');
      const colRef = collection(db, 'artifacts', appId, 'public', 'data', `activities_${safeUsername}`);
      
      const unsubscribe = onSnapshot(colRef, (snapshot) => {
        const data = snapshot.docs.map(doc => doc.data());
        data.sort((a, b) => a.id.localeCompare(b.id)); 
        setActivities(data);
        setIsLoading(false);
      }, (error) => {
        console.error("Firestore error:", error);
        setIsLoading(false);
      });

      return () => unsubscribe();
    } 
    
    // 本機模式
    if (storageMode === 'local') {
      // 嘗試讀取專用本機資料，或舊版未分模式時的資料
      const saved = localStorage.getItem('activityTrackerData_local') || localStorage.getItem('activityTrackerData');
      if (saved) {
        try {
          setActivities(JSON.parse(saved));
        } catch (e) {
          setActivities([]);
        }
      } else {
        setActivities([]);
      }
      setIsLoading(false);
    }
  }, [authUser, currentUser, storageMode]);

  // --- Local Storage Sync Effect ---
  // 當處於本機模式且 activities 變更時，自動存入 localStorage
  useEffect(() => {
    if (storageMode === 'local') {
      localStorage.setItem('activityTrackerData_local', JSON.stringify(activities));
    }
  }, [activities, storageMode]);

  // --- Handlers ---
  const handleLoginCloud = (e) => {
    e.preventDefault();
    const name = usernameInput.trim();
    if (name) {
      setCurrentUser(name);
      setStorageMode('cloud');
      localStorage.setItem('tracker_username', name);
      localStorage.setItem('tracker_storage_mode', 'cloud');
      setUsernameInput('');
    }
  };

  const handleLoginLocal = () => {
    setStorageMode('local');
    localStorage.setItem('tracker_storage_mode', 'local');
    // 如果之前有舊版紀錄，確保也能使用
  };

  const handleLogout = () => {
    setCurrentUser('');
    setStorageMode(null);
    localStorage.removeItem('tracker_username');
    localStorage.removeItem('tracker_storage_mode');
    setActivities([]);
    setSelectedActivityId(null);
  };

  const loadDefaultActivities = async () => {
    setIsLoading(true);
    if (storageMode === 'cloud' && currentUser) {
      try {
        const safeUsername = currentUser.replace(/\//g, '_');
        for (const act of INITIAL_ACTIVITIES) {
          const docRef = doc(db, 'artifacts', appId, 'public', 'data', `activities_${safeUsername}`, act.id);
          await setDoc(docRef, act);
        }
      } catch (error) {
        console.error("Error loading defaults:", error);
      }
    } else if (storageMode === 'local') {
      setActivities(INITIAL_ACTIVITIES);
    }
    setIsLoading(false);
  };

  const handleAddActivity = async (e) => {
    e.preventDefault();
    if (!newActivityName.trim()) return;
    const newId = generateId();
    const newActivity = { id: newId, name: newActivityName.trim(), records: [] };

    if (storageMode === 'cloud' && currentUser) {
      const safeUsername = currentUser.replace(/\//g, '_');
      const docRef = doc(db, 'artifacts', appId, 'public', 'data', `activities_${safeUsername}`, newId);
      await setDoc(docRef, newActivity);
    } else if (storageMode === 'local') {
      setActivities(prev => [...prev, newActivity]);
    }
    
    setNewActivityName('');
  };

  const handleAddRecord = async (id, e) => {
    if (e) e.stopPropagation();
    
    const activity = activities.find(a => a.id === id);
    if (!activity) return;
    const now = new Date().toISOString();

    if (storageMode === 'cloud' && currentUser) {
      const safeUsername = currentUser.replace(/\//g, '_');
      const docRef = doc(db, 'artifacts', appId, 'public', 'data', `activities_${safeUsername}`, id);
      await updateDoc(docRef, { records: [...activity.records, now] });
    } else if (storageMode === 'local') {
      setActivities(prev => prev.map(act => 
        act.id === id ? { ...act, records: [...act.records, now] } : act
      ));
    }
  };

  const handleDeleteActivity = async (id) => {
    if (storageMode === 'cloud' && currentUser) {
      const safeUsername = currentUser.replace(/\//g, '_');
      const docRef = doc(db, 'artifacts', appId, 'public', 'data', `activities_${safeUsername}`, id);
      await deleteDoc(docRef);
    } else if (storageMode === 'local') {
      setActivities(prev => prev.filter(act => act.id !== id));
    }
    setSelectedActivityId(null);
  };

  const handleClearRecords = async (id, beforeDateStr) => {
    const activity = activities.find(a => a.id === id);
    if (!activity) return;

    const cutoffTime = new Date(beforeDateStr).getTime();
    const filteredRecords = activity.records.filter(r => new Date(r).getTime() >= cutoffTime);
    
    if (storageMode === 'cloud' && currentUser) {
      const safeUsername = currentUser.replace(/\//g, '_');
      const docRef = doc(db, 'artifacts', appId, 'public', 'data', `activities_${safeUsername}`, id);
      await updateDoc(docRef, { records: filteredRecords });
    } else if (storageMode === 'local') {
      setActivities(prev => prev.map(act => 
        act.id === id ? { ...act, records: filteredRecords } : act
      ));
    }
  };

  const selectedActivity = activities.find(a => a.id === selectedActivityId);

  // --- Login & Selection View ---
  if (!storageMode) {
    return (
      <div className="min-h-screen bg-gray-100 flex items-center justify-center font-sans p-4">
        <div className="bg-white p-8 rounded-2xl shadow-xl max-w-sm w-full">
          <div className="flex justify-center gap-4 mb-6">
            <div className="bg-blue-100 p-4 rounded-full text-blue-600">
              <Cloud size={32} />
            </div>
            <div className="bg-gray-100 p-4 rounded-full text-gray-600">
              <Smartphone size={32} />
            </div>
          </div>
          <h1 className="text-2xl font-bold text-center text-gray-800 mb-2">紀錄小幫手</h1>
          <p className="text-center text-gray-500 mb-8 text-sm">請選擇您的使用方式</p>
          
          <form onSubmit={handleLoginCloud} className="space-y-4">
            <div>
              <input
                type="text"
                value={usernameInput}
                onChange={(e) => setUsernameInput(e.target.value)}
                placeholder="輸入名稱 (雲端同步使用)"
                className="w-full border border-gray-300 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 transition shadow-sm"
              />
            </div>
            <button
              type="submit"
              disabled={!usernameInput.trim()}
              className="w-full bg-blue-600 text-white rounded-xl px-4 py-3 font-bold shadow-md hover:bg-blue-700 disabled:bg-blue-300 transition"
            >
              啟用雲端同步
            </button>
          </form>

          <div className="relative flex py-6 items-center">
            <div className="flex-grow border-t border-gray-200"></div>
            <span className="flex-shrink-0 mx-4 text-gray-400 text-sm">或</span>
            <div className="flex-grow border-t border-gray-200"></div>
          </div>

          <button
            onClick={handleLoginLocal}
            className="w-full bg-gray-100 text-gray-700 rounded-xl px-4 py-3 font-bold shadow-sm hover:bg-gray-200 transition flex items-center justify-center gap-2"
          >
            <Smartphone size={20} />
            僅在本機使用 (免網路)
          </button>
        </div>
      </div>
    );
  }

  // --- Loading View ---
  if (isLoading && activities.length === 0) {
    return (
      <div className="min-h-screen bg-gray-100 flex items-center justify-center">
        <div className="animate-spin rounded-full h-12 w-12 border-4 border-blue-500 border-t-transparent"></div>
      </div>
    );
  }

  // --- Main Views ---
  return (
    <div className="min-h-screen bg-gray-100 font-sans text-gray-800">
      <div className="max-w-md mx-auto bg-white min-h-screen shadow-lg flex flex-col relative overflow-hidden">
        
        <header className="bg-blue-600 text-white p-4 shadow-md z-10 flex items-center justify-between">
          <div className="flex items-center gap-2 flex-1 overflow-hidden">
            {storageMode === 'cloud' ? <Cloud size={20} /> : <Smartphone size={20} />}
            <h1 className="text-xl font-bold truncate">
              {selectedActivity 
                ? selectedActivity.name 
                : (storageMode === 'cloud' ? `${currentUser} 的雲端紀錄` : '本機紀錄')}
            </h1>
          </div>
          {!selectedActivityId && (
            <button onClick={handleLogout} className="p-2 hover:bg-blue-700 rounded-full transition ml-2" title="切換模式或帳號">
              <LogOut size={20} />
            </button>
          )}
        </header>

        <main className="flex-1 overflow-y-auto">
          {!selectedActivityId ? (
            <HomeView 
              activities={activities}
              newActivityName={newActivityName}
              setNewActivityName={setNewActivityName}
              onAddActivity={handleAddActivity}
              onAddRecord={handleAddRecord}
              onSelectActivity={setSelectedActivityId}
              onLoadDefaults={loadDefaultActivities}
            />
          ) : (
            <DetailView 
              activity={selectedActivity}
              onBack={() => setSelectedActivityId(null)}
              onAddRecord={() => handleAddRecord(selectedActivity.id)}
              onClearRecords={(date) => handleClearRecords(selectedActivity.id, date)}
              onDeleteActivity={() => handleDeleteActivity(selectedActivity.id)}
            />
          )}
        </main>
      </div>
    </div>
  );
}

// ==========================================
// Home View Component
// ==========================================
function HomeView({ 
  activities, 
  newActivityName, 
  setNewActivityName, 
  onAddActivity, 
  onAddRecord, 
  onSelectActivity,
  onLoadDefaults 
}) {
  return (
    <div className="p-4 flex flex-col h-full">
      {/* 新增項目表單 */}
      <form onSubmit={onAddActivity} className="flex gap-2 mb-6">
        <input 
          type="text" 
          value={newActivityName}
          onChange={(e) => setNewActivityName(e.target.value)}
          placeholder="輸入新追蹤項目 (例: 喝水)" 
          className="flex-1 border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 text-lg shadow-sm"
        />
        <button 
          type="submit" 
          disabled={!newActivityName.trim()}
          className="bg-blue-600 text-white rounded-lg px-4 py-3 disabled:bg-blue-300 active:bg-blue-700 transition flex items-center shadow-sm"
        >
          <Plus size={24} />
        </button>
      </form>

      {/* 項目列表 */}
      <div className="flex-1 space-y-3">
        {activities.map(activity => (
          <div 
            key={activity.id} 
            onClick={() => onSelectActivity(activity.id)}
            className="bg-white border border-gray-100 rounded-xl p-4 shadow-sm hover:shadow-md transition cursor-pointer flex items-center justify-between group"
          >
            <div className="flex-1">
              <h3 className="text-lg font-semibold text-gray-800">{activity.name}</h3>
              <p className="text-sm text-gray-500 mt-1">
                總計: <span className="font-bold text-blue-600">{activity.records.length}</span> 次
              </p>
            </div>
            
            <button 
              onClick={(e) => onAddRecord(activity.id, e)}
              className="ml-4 bg-blue-100 text-blue-700 hover:bg-blue-200 rounded-full h-12 w-12 flex items-center justify-center font-bold text-lg transition-colors shadow-sm active:scale-95"
            >
              +1
            </button>
          </div>
        ))}

        {activities.length === 0 && (
          <div className="text-center py-10 flex flex-col items-center">
            <p className="text-gray-400 mb-4">目前沒有任何項目，請在上方新增！</p>
            {onLoadDefaults && (
              <button 
                onClick={onLoadDefaults}
                className="bg-blue-100 text-blue-700 px-6 py-2 rounded-xl font-bold shadow-sm hover:bg-blue-200 transition"
              >
                或點此載入預設項目
              </button>
            )}
          </div>
        )}
      </div>
    </div>
  );
}

// ==========================================
// Detail & Calendar View Component
// ==========================================
function DetailView({ activity, onBack, onAddRecord, onClearRecords, onDeleteActivity }) {
  const [currentMonth, setCurrentMonth] = useState(new Date());
  const [selectedDateStr, setSelectedDateStr] = useState(
    new Date().toLocaleDateString('en-CA') // YYYY-MM-DD local
  );

  // 取得當月的第一天和總天數
  const year = currentMonth.getFullYear();
  const month = currentMonth.getMonth();
  const firstDayOfMonth = new Date(year, month, 1).getDay();
  const daysInMonth = new Date(year, month + 1, 0).getDate();

  // 將記錄轉化為以 YYYY-MM-DD 為 key 的物件，方便月曆查詢
  const recordsByDate = useMemo(() => {
    const map = {};
    activity.records.forEach(r => {
      const dateObj = new Date(r);
      const dateStr = dateObj.toLocaleDateString('en-CA');
      if (!map[dateStr]) map[dateStr] = [];
      map[dateStr].push(dateObj);
    });
    // 依時間排序
    Object.keys(map).forEach(k => {
      map[k].sort((a, b) => b - a);
    });
    return map;
  }, [activity.records]);

  const handlePrevMonth = () => setCurrentMonth(new Date(year, month - 1, 1));
  const handleNextMonth = () => setCurrentMonth(new Date(year, month + 1, 1));

  // 產生月曆陣列
  const calendarDays = [];
  for (let i = 0; i < firstDayOfMonth; i++) calendarDays.push(null); // 空白格子
  for (let i = 1; i <= daysInMonth; i++) calendarDays.push(i);

  // 選中日期的所有紀錄
  const selectedDayRecords = recordsByDate[selectedDateStr] || [];

  return (
    <div className="flex flex-col h-full bg-gray-50 pb-8">
      {/* 導覽列 */}
      <div className="bg-white px-4 py-3 flex items-center justify-between shadow-sm sticky top-0 z-10">
        <button onClick={onBack} className="text-gray-600 hover:bg-gray-100 p-2 rounded-full transition">
          <ChevronLeft size={24} />
        </button>
        <div className="flex-1 text-center font-bold text-lg text-gray-800">
          總計 {activity.records.length} 次
        </div>
        <button onClick={onAddRecord} className="text-blue-600 hover:bg-blue-50 p-2 rounded-full transition font-bold flex items-center gap-1">
          <Plus size={20} /> 記一筆
        </button>
      </div>

      <div className="p-4 space-y-6 flex-1 overflow-y-auto">
        
        {/* 月曆區塊 */}
        <div className="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
          {/* 月曆控制 */}
          <div className="flex justify-between items-center p-4 bg-gray-50 border-b border-gray-100">
            <button onClick={handlePrevMonth} className="p-1 hover:bg-gray-200 rounded-full"><ChevronLeft size={20} /></button>
            <h2 className="font-bold text-lg">{year} 年 {month + 1} 月</h2>
            <button onClick={handleNextMonth} className="p-1 hover:bg-gray-200 rounded-full"><ChevronRight size={20} /></button>
          </div>

          {/* 星期標題 */}
          <div className="grid grid-cols-7 text-center text-xs font-semibold text-gray-500 py-2 bg-white">
            <div>日</div><div>一</div><div>二</div><div>三</div><div>四</div><div>五</div><div>六</div>
          </div>

          {/* 日期格子 */}
          <div className="grid grid-cols-7 text-center bg-white pb-2">
            {calendarDays.map((day, idx) => {
              if (!day) return <div key={`empty-${idx}`} className="py-2"></div>;
              
              const dateStr = new Date(year, month, day).toLocaleDateString('en-CA');
              const hasRecord = !!recordsByDate[dateStr];
              const recordCount = hasRecord ? recordsByDate[dateStr].length : 0;
              const isSelected = selectedDateStr === dateStr;
              const isToday = dateStr === new Date().toLocaleDateString('en-CA');

              return (
                <div key={day} className="py-1 px-1 flex justify-center">
                  <button 
                    onClick={() => setSelectedDateStr(dateStr)}
                    className={`w-10 h-10 rounded-full flex flex-col items-center justify-center relative transition-all
                      ${isSelected ? 'bg-blue-600 text-white shadow-md' : 'hover:bg-gray-100'}
                      ${isToday && !isSelected ? 'border border-blue-600 text-blue-600' : ''}
                      ${!isSelected && !isToday ? 'text-gray-700' : ''}
                    `}
                  >
                    <span className="text-sm">{day}</span>
                    {/* 有紀錄的提示小點 */}
                    {hasRecord && (
                      <span className={`w-1.5 h-1.5 rounded-full mt-0.5 ${isSelected ? 'bg-white' : 'bg-blue-500'}`}></span>
                    )}
                  </button>
                </div>
              );
            })}
          </div>
        </div>

        {/* 選擇日期的詳細紀錄 */}
        <div className="bg-white rounded-2xl shadow-sm border border-gray-100 p-4">
          <h3 className="font-bold flex items-center gap-2 text-gray-700 mb-4 border-b pb-2">
            <CalendarIcon size={18} />
            {selectedDateStr} 紀錄
            <span className="ml-auto text-sm font-normal text-gray-500">
              共 {selectedDayRecords.length} 次
            </span>
          </h3>

          {selectedDayRecords.length > 0 ? (
            <ul className="space-y-3">
              {selectedDayRecords.map((dateObj, idx) => (
                <li key={idx} className="flex items-center gap-3 bg-gray-50 p-3 rounded-lg text-gray-700">
                  <Clock size={16} className="text-blue-500" />
                  <span className="font-medium text-lg">
                    {dateObj.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit', second: '2-digit' })}
                  </span>
                </li>
              ))}
            </ul>
          ) : (
            <div className="text-center text-gray-400 py-6">
              這天沒有紀錄唷！
            </div>
          )}
        </div>

        {/* 資料清理與管理區塊 */}
        <div className="pt-6 border-t border-gray-200">
          <h4 className="text-sm font-bold text-gray-400 uppercase tracking-wider mb-3 px-2">資料管理</h4>
          <div className="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden divide-y divide-gray-100">
            <ClearButton label="清除一週前的紀錄" days={7} onClear={onClearRecords} />
            <ClearButton label="清除一個月前的紀錄" days={30} onClear={onClearRecords} />
            <ClearButton label="清除一年前的紀錄" days={365} onClear={onClearRecords} />
            
            {/* 刪除整個項目 */}
            <div className="p-2">
              <ConfirmButton 
                initLabel="刪除此追蹤項目" 
                confirmLabel="確定刪除？(無法復原)"
                onClick={onDeleteActivity}
                isDanger={true}
              />
            </div>
          </div>
        </div>

      </div>
    </div>
  );
}

// --- 輔助防呆按鈕元件 ---
function ClearButton({ label, days, onClear }) {
  const handleClear = () => {
    const targetDate = new Date();
    targetDate.setDate(targetDate.getDate() - days);
    onClear(targetDate.toISOString());
  };

  return (
    <div className="p-2">
      <ConfirmButton 
        initLabel={label} 
        confirmLabel="確定清除？"
        onClick={handleClear}
      />
    </div>
  );
}

function ConfirmButton({ initLabel, confirmLabel, onClick, isDanger = false }) {
  const [confirming, setConfirming] = useState(false);

  if (confirming) {
    return (
      <div className="flex gap-2 w-full">
        <button 
          onClick={(e) => { e.stopPropagation(); setConfirming(false); }}
          className="flex-1 py-3 px-4 rounded-xl bg-gray-100 text-gray-700 font-medium flex justify-center items-center gap-1 active:bg-gray-200"
        >
          <X size={18} /> 取消
        </button>
        <button 
          onClick={(e) => { e.stopPropagation(); onClick(); setConfirming(false); }}
          className={`flex-1 py-3 px-4 rounded-xl font-medium flex justify-center items-center gap-1 text-white shadow-sm transition
            ${isDanger ? 'bg-red-600 active:bg-red-700' : 'bg-blue-600 active:bg-blue-700'}
          `}
        >
          <Check size={18} /> {confirmLabel}
        </button>
      </div>
    );
  }

  return (
    <button 
      onClick={(e) => { e.stopPropagation(); setConfirming(true); }}
      className={`w-full py-3 px-4 rounded-xl font-medium text-left transition flex items-center justify-between
        ${isDanger ? 'text-red-600 hover:bg-red-50' : 'text-gray-700 hover:bg-gray-50'}
      `}
    >
      {initLabel}
      {isDanger && <Trash2 size={18} />}
    </button>
  );
}